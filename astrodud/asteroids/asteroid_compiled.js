var THREE=THREE||{};Color=function(a){this.autoUpdate=true;this.setHex(a)};
Color.prototype={setRGB:function(a,b,c){this.r=a;this.g=b;this.b=c;if(this.autoUpdate){this.updateHex();this.updateStyleString()}},setHSV:function(a,b,c){var d,f,g,j,l,k;if(c==0)d=f=g=0;else{j=Math.floor(a*6);l=a*6-j;a=c*(1-b);k=c*(1-b*l);b=c*(1-b*(1-l));switch(j){case 1:d=k;f=c;g=a;break;case 2:d=a;f=c;g=b;break;case 3:d=a;f=k;g=c;break;case 4:d=b;f=a;g=c;break;case 5:d=c;f=a;g=k;break;case 6:case 0:d=c;f=b;g=a}}this.r=d;this.g=f;this.b=g;if(this.autoUpdate){this.updateHex();this.updateStyleString()}},
setHex:function(a){this.hex=~~a&16777215;if(this.autoUpdate){this.updateRGBA();this.updateStyleString()}},updateHex:function(){this.hex=~~(this.r*255)<<16^~~(this.g*255)<<8^~~(this.b*255)},updateRGBA:function(){this.r=(this.hex>>16&255)/255;this.g=(this.hex>>8&255)/255;this.b=(this.hex&255)/255},updateStyleString:function(){this.__styleString="rgb("+~~(this.r*255)+","+~~(this.g*255)+","+~~(this.b*255)+")"},clone:function(){return new Color(this.hex)},toString:function(){return"Color ( r: "+
this.r+", g: "+this.g+", b: "+this.b+", hex: "+this.hex+" )"}};Vector2=function(a,b){this.x=a||0;this.y=b||0};
Vector2.prototype={set:function(a,b){this.x=a;this.y=b;return this},cy:function(a){this.x=a.x;this.y=a.y;return this},aS:function(a){this.x+=a.x;this.y+=a.y;return this},add:function(a,b){this.x=a.x+b.x;this.y=a.y+b.y;return this},subSelf:function(a){this.x-=a.x;this.y-=a.y;return this},sub:function(a,b){this.x=a.x-b.x;this.y=a.y-b.y;return this},ms:function(a){this.x*=a;this.y*=a;return this},unit:function(){this.ms(1/this.length());return this},length:function(){return Math.sqrt(this.x*
this.x+this.y*this.y)},lengthSq:function(){return this.x*this.x+this.y*this.y},negate:function(){this.x=-this.x;this.y=-this.y;return this},clone:function(){return new Vector2(this.x,this.y)},toString:function(){return"Vector2 ("+this.x+", "+this.y+")"}};v3=function(a,b,c){this.x=a||0;this.y=b||0;this.z=c||0};
v3.prototype={set:function(a,b,c){this.x=a;this.y=b;this.z=c;return this},cy:function(a){this.x=a.x;this.y=a.y;this.z=a.z;return this},add:function(a,b){this.x=a.x+b.x;this.y=a.y+b.y;this.z=a.z+b.z;return this},aS:function(a){this.x+=a.x;this.y+=a.y;this.z+=a.z;return this},aSc:function(a){this.x+=a;this.y+=a;this.z+=a;return this},sub:function(a,b){this.x=a.x-b.x;this.y=a.y-b.y;this.z=a.z-b.z;return this},subSelf:function(a){this.x-=a.x;this.y-=a.y;this.z-=a.z;return this},
cross:function(a,b){this.x=a.y*b.z-a.z*b.y;this.y=a.z*b.x-a.x*b.z;this.z=a.x*b.y-a.y*b.x;return this},crossSelf:function(a){var b=this.x,c=this.y,d=this.z;this.x=c*a.z-d*a.y;this.y=d*a.x-b*a.z;this.z=b*a.y-c*a.x;return this},multiply:function(a,b){this.x=a.x*b.x;this.y=a.y*b.y;this.z=a.z*b.z;return this},mS:function(a){this.x*=a.x;this.y*=a.y;this.z*=a.z;return this},ms:function(a){this.x*=a;this.y*=a;this.z*=a;return this},divideSelf:function(a){this.x/=a.x;this.y/=a.y;this.z/=
a.z;return this},divideScalar:function(a){this.x/=a;this.y/=a;this.z/=a;return this},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z},distanceTo:function(a){var b=this.x-a.x,c=this.y-a.y;a=this.z-a.z;return Math.sqrt(b*b+c*c+a*a)},distanceToSquared:function(a){var b=this.x-a.x,c=this.y-a.y;a=this.z-a.z;return b*b+c*c+a*a},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},negate:function(){this.x=
-this.x;this.y=-this.y;this.z=-this.z;return this},normalize:function(){var a=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);a>0?this.ms(1/a):this.set(0,0,0);return this},setLength:function(a){return this.normalize().ms(a)},isZero:function(){return Math.abs(this.x)<1.0E-4&&Math.abs(this.y)<1.0E-4&&Math.abs(this.z)<1.0E-4},clone:function(){return new v3(this.x,this.y,this.z)},toString:function(){return"v3 ( "+this.x+", "+this.y+", "+this.z+" )"}};
Vector4=function(a,b,c,d){this.x=a||0;this.y=b||0;this.z=c||0;this.w=d||1};
Vector4.prototype={set:function(a,b,c,d){this.x=a;this.y=b;this.z=c;this.w=d;return this},cy:function(a){this.x=a.x;this.y=a.y;this.z=a.z;this.w=a.w||1;return this},add:function(a,b){this.x=a.x+b.x;this.y=a.y+b.y;this.z=a.z+b.z;this.w=a.w+b.w;return this},aS:function(a){this.x+=a.x;this.y+=a.y;this.z+=a.z;this.w+=a.w;return this},sub:function(a,b){this.x=a.x-b.x;this.y=a.y-b.y;this.z=a.z-b.z;this.w=a.w-b.w;return this},subSelf:function(a){this.x-=a.x;this.y-=a.y;this.z-=a.z;this.w-=a.w;
return this},ms:function(a){this.x*=a;this.y*=a;this.z*=a;this.w*=a;return this},divideScalar:function(a){this.x/=a;this.y/=a;this.z/=a;this.w/=a;return this},lerpSelf:function(a,b){this.x+=(a.x-this.x)*b;this.y+=(a.y-this.y)*b;this.z+=(a.z-this.z)*b;this.w+=(a.w-this.w)*b},clone:function(){return new Vector4(this.x,this.y,this.z,this.w)},toString:function(){return"Vector4 ("+this.x+", "+this.y+", "+this.z+", "+this.w+")"}};
Ray=function(a,b){this.origin=a||new v3;this.direction=b||new v3};
Ray.prototype={intersectScene:function(a){var b,c,d=a.objects,f=[];a=0;for(b=d.length;a<b;a++){c=d[a];if(c instanceof Mesh)f=f.concat(this.intersectoB(c))}f.sort(function(g,j){return g.distance-j.distance});return f},intersectoB:function(a){function b(A,t,I,D){D=D.clone().subSelf(t);I=I.clone().subSelf(t);var e=A.clone().subSelf(t);A=D.dot(D);t=D.dot(I);D=D.dot(e);var P=I.dot(I);I=I.dot(e);e=1/(A*P-t*t);P=(P*D-t*I)*e;A=(A*I-t*D)*e;return P>0&&A>0&&P+A<1}var c,d,f,g,j,l,k,q,w,v,
x,m=a.gG,y=m.vts,B=[];c=0;for(d=m.faces.length;c<d;c++){f=m.faces[c];v=this.origin.clone();x=this.direction.clone();g=a.matrix.mV3(y[f.a].ppos.clone());j=a.matrix.mV3(y[f.b].ppos.clone());l=a.matrix.mV3(y[f.c].ppos.clone());k=f instanceof Face4?a.matrix.mV3(y[f.d].ppos.clone()):null;q=a.rtMatrix.mV3(f.normal.clone());w=x.dot(q);if(w<0){q=q.dot((new v3).sub(g,v))/w;v=v.aS(x.ms(q));
if(f instanceof Face3){if(b(v,g,j,l)){f={distance:this.origin.distanceTo(v),point:v,face:f,object:a};B.push(f)}}else if(f instanceof Face4)if(b(v,g,j,k)||b(v,j,l,k)){f={distance:this.origin.distanceTo(v),point:v,face:f,object:a};B.push(f)}}}return B}};
Rectangle=function(){function a(){g=d-b;j=f-c}var b,c,d,f,g,j,l=true;this.getX=function(){return b};this.getY=function(){return c};this.getWidth=function(){return g};this.getHeight=function(){return j};this.getLeft=function(){return b};this.getTop=function(){return c};this.getRight=function(){return d};this.getBottom=function(){return f};this.set=function(k,q,w,v){l=false;b=k;c=q;d=w;f=v;a()};this.addPoint=function(k,q){if(l){l=false;b=k;c=q;d=k;f=q}else{b=b<k?b:k;c=c<q?c:q;d=d>k?d:k;f=f>q?
f:q}a()};this.add3Points=function(k,q,w,v,x,m){if(l){l=false;b=k<w?k<x?k:x:w<x?w:x;c=q<v?q<m?q:m:v<m?v:m;d=k>w?k>x?k:x:w>x?w:x;f=q>v?q>m?q:m:v>m?v:m}else{b=k<w?k<x?k<b?k:b:x<b?x:b:w<x?w<b?w:b:x<b?x:b;c=q<v?q<m?q<c?q:c:m<c?m:c:v<m?v<c?v:c:m<c?m:c;d=k>w?k>x?k>d?k:d:x>d?x:d:w>x?w>d?w:d:x>d?x:d;f=q>v?q>m?q>f?q:f:m>f?m:f:v>m?v>f?v:f:m>f?m:f}a()};this.addRectangle=function(k){if(l){l=false;b=k.getLeft();c=k.getTop();d=k.getRight();f=k.getBottom()}else{b=b<k.getLeft()?b:k.getLeft();c=c<k.getTop()?c:k.getTop();
d=d>k.getRight()?d:k.getRight();f=f>k.getBottom()?f:k.getBottom()}a()};this.inflate=function(k){b-=k;c-=k;d+=k;f+=k;a()};this.minSelf=function(k){b=b>k.getLeft()?b:k.getLeft();c=c>k.getTop()?c:k.getTop();d=d<k.getRight()?d:k.getRight();f=f<k.getBottom()?f:k.getBottom();a()};this.instersects=function(k){return Math.min(d,k.getRight())-Math.max(b,k.getLeft())>=0&&Math.min(f,k.getBottom())-Math.max(c,k.getTop())>=0};this.empty=function(){l=true;f=d=c=b=0;a()};this.isEmpty=function(){return l};this.toString=
function(){return"Rectangle ( left: "+b+", right: "+d+", top: "+c+", bottom: "+f+", width: "+g+", height: "+j+" )"}};Matrix3=function(){this.m=[]};Matrix3.prototype={transpose:function(){var a,b=this.m;a=b[1];b[1]=b[3];b[3]=a;a=b[2];b[2]=b[6];b[6]=a;a=b[5];b[5]=b[7];b[7]=a;return this},transposeIntoArray:function(a){var b=this.m;a[0]=b[0];a[1]=b[3];a[2]=b[6];a[3]=b[1];a[4]=b[4];a[5]=b[7];a[6]=b[2];a[7]=b[5];a[8]=b[8];return this}};
m4=function(a,b,c,d,f,g,j,l,k,q,w,v,x,m,y,B){this.n11=a||1;this.n12=b||0;this.n13=c||0;this.n14=d||0;this.n21=f||0;this.n22=g||1;this.n23=j||0;this.n24=l||0;this.n31=k||0;this.n32=q||0;this.n33=w||1;this.n34=v||0;this.n41=x||0;this.n42=m||0;this.n43=y||0;this.n44=B||1;this.flat=Array(16);this.m33=new Matrix3};
m4.prototype={identity:function(){this.n11=1;this.n21=this.n14=this.n13=this.n12=0;this.n22=1;this.n32=this.n31=this.n24=this.n23=0;this.n33=1;this.n43=this.n42=this.n41=this.n34=0;this.n44=1;return this},set:function(a,b,c,d,f,g,j,l,k,q,w,v,x,m,y,B){this.n11=a;this.n12=b;this.n13=c;this.n14=d;this.n21=f;this.n22=g;this.n23=j;this.n24=l;this.n31=k;this.n32=q;this.n33=w;this.n34=v;this.n41=x;this.n42=m;this.n43=y;this.n44=B;return this},cy:function(a){this.n11=a.n11;this.n12=a.n12;this.n13=
a.n13;this.n14=a.n14;this.n21=a.n21;this.n22=a.n22;this.n23=a.n23;this.n24=a.n24;this.n31=a.n31;this.n32=a.n32;this.n33=a.n33;this.n34=a.n34;this.n41=a.n41;this.n42=a.n42;this.n43=a.n43;this.n44=a.n44;return this},lookAt:function(a,b,c){var d=m4.__tmpVec1,f=m4.__tmpVec2,g=m4.__tmpVec3;g.sub(a,b).normalize();d.cross(c,g).normalize();f.cross(g,d).normalize();this.n11=d.x;this.n12=d.y;this.n13=d.z;this.n14=-d.dot(a);this.n21=f.x;this.n22=f.y;this.n23=f.z;this.n24=-f.dot(a);
this.n31=g.x;this.n32=g.y;this.n33=g.z;this.n34=-g.dot(a);this.n43=this.n42=this.n41=0;this.n44=1;return this},mV3:function(a){var b=a.x,c=a.y,d=a.z,f=1/(this.n41*b+this.n42*c+this.n43*d+this.n44);a.x=(this.n11*b+this.n12*c+this.n13*d+this.n14)*f;a.y=(this.n21*b+this.n22*c+this.n23*d+this.n24)*f;a.z=(this.n31*b+this.n32*c+this.n33*d+this.n34)*f;return a},mV4:function(a){var b=a.x,c=a.y,d=a.z,f=a.w;a.x=this.n11*b+this.n12*c+this.n13*d+this.n14*f;a.y=this.n21*b+this.n22*c+this.n23*
d+this.n24*f;a.z=this.n31*b+this.n32*c+this.n33*d+this.n34*f;a.w=this.n41*b+this.n42*c+this.n43*d+this.n44*f;return a},crossVector:function(a){var b=new Vector4;b.x=this.n11*a.x+this.n12*a.y+this.n13*a.z+this.n14*a.w;b.y=this.n21*a.x+this.n22*a.y+this.n23*a.z+this.n24*a.w;b.z=this.n31*a.x+this.n32*a.y+this.n33*a.z+this.n34*a.w;b.w=a.w?this.n41*a.x+this.n42*a.y+this.n43*a.z+this.n44*a.w:1;return b},multiply:function(a,b){var c=a.n11,d=a.n12,f=a.n13,g=a.n14,j=a.n21,l=a.n22,k=a.n23,q=a.n24,w=a.n31,
v=a.n32,x=a.n33,m=a.n34,y=a.n41,B=a.n42,A=a.n43,t=a.n44,I=b.n11,D=b.n12,e=b.n13,P=b.n14,U=b.n21,F=b.n22,L=b.n23,T=b.n24,N=b.n31,S=b.n32,R=b.n33,J=b.n34,E=b.n41,Y=b.n42,M=b.n43,X=b.n44;this.n11=c*I+d*U+f*N+g*E;this.n12=c*D+d*F+f*S+g*Y;this.n13=c*e+d*L+f*R+g*M;this.n14=c*P+d*T+f*J+g*X;this.n21=j*I+l*U+k*N+q*E;this.n22=j*D+l*F+k*S+q*Y;this.n23=j*e+l*L+k*R+q*M;this.n24=j*P+l*T+k*J+q*X;this.n31=w*I+v*U+x*N+m*E;this.n32=w*D+v*F+x*S+m*Y;this.n33=w*e+v*L+x*R+m*M;this.n34=w*P+v*T+x*J+m*X;this.n41=y*I+B*U+
A*N+t*E;this.n42=y*D+B*F+A*S+t*Y;this.n43=y*e+B*L+A*R+t*M;this.n44=y*P+B*T+A*J+t*X;return this},multiplyToArray:function(a,b,c){var d=a.n11,f=a.n12,g=a.n13,j=a.n14,l=a.n21,k=a.n22,q=a.n23,w=a.n24,v=a.n31,x=a.n32,m=a.n33,y=a.n34,B=a.n41,A=a.n42,t=a.n43;a=a.n44;var I=b.n11,D=b.n12,e=b.n13,P=b.n14,U=b.n21,F=b.n22,L=b.n23,T=b.n24,N=b.n31,S=b.n32,R=b.n33,J=b.n34,E=b.n41,Y=b.n42,M=b.n43;b=b.n44;this.n11=d*I+f*U+g*N+j*E;this.n12=d*D+f*F+g*S+j*Y;this.n13=d*e+f*L+g*R+j*M;this.n14=d*P+f*T+g*J+j*b;this.n21=
l*I+k*U+q*N+w*E;this.n22=l*D+k*F+q*S+w*Y;this.n23=l*e+k*L+q*R+w*M;this.n24=l*P+k*T+q*J+w*b;this.n31=v*I+x*U+m*N+y*E;this.n32=v*D+x*F+m*S+y*Y;this.n33=v*e+x*L+m*R+y*M;this.n34=v*P+x*T+m*J+y*b;this.n41=B*I+A*U+t*N+a*E;this.n42=B*D+A*F+t*S+a*Y;this.n43=B*e+A*L+t*R+a*M;this.n44=B*P+A*T+t*J+a*b;c[0]=this.n11;c[1]=this.n21;c[2]=this.n31;c[3]=this.n41;c[4]=this.n12;c[5]=this.n22;c[6]=this.n32;c[7]=this.n42;c[8]=this.n13;c[9]=this.n23;c[10]=this.n33;c[11]=this.n43;c[12]=this.n14;c[13]=this.n24;c[14]=this.n34;
c[15]=this.n44;return this},mS:function(a){var b=this.n11,c=this.n12,d=this.n13,f=this.n14,g=this.n21,j=this.n22,l=this.n23,k=this.n24,q=this.n31,w=this.n32,v=this.n33,x=this.n34,m=this.n41,y=this.n42,B=this.n43,A=this.n44,t=a.n11,I=a.n21,D=a.n31,e=a.n41,P=a.n12,U=a.n22,F=a.n32,L=a.n42,T=a.n13,N=a.n23,S=a.n33,R=a.n43,J=a.n14,E=a.n24,Y=a.n34;a=a.n44;this.n11=b*t+c*I+d*D+f*e;this.n12=b*P+c*U+d*F+f*L;this.n13=b*T+c*N+d*S+f*R;this.n14=b*J+c*E+d*Y+f*a;this.n21=g*t+j*I+l*D+k*e;this.n22=g*P+j*
U+l*F+k*L;this.n23=g*T+j*N+l*S+k*R;this.n24=g*J+j*E+l*Y+k*a;this.n31=q*t+w*I+v*D+x*e;this.n32=q*P+w*U+v*F+x*L;this.n33=q*T+w*N+v*S+x*R;this.n34=q*J+w*E+v*Y+x*a;this.n41=m*t+y*I+B*D+A*e;this.n42=m*P+y*U+B*F+A*L;this.n43=m*T+y*N+B*S+A*R;this.n44=m*J+y*E+B*Y+A*a;return this},ms:function(a){this.n11*=a;this.n12*=a;this.n13*=a;this.n14*=a;this.n21*=a;this.n22*=a;this.n23*=a;this.n24*=a;this.n31*=a;this.n32*=a;this.n33*=a;this.n34*=a;this.n41*=a;this.n42*=a;this.n43*=a;this.n44*=a;return this},
determinant:function(){var a=this.n11,b=this.n12,c=this.n13,d=this.n14,f=this.n21,g=this.n22,j=this.n23,l=this.n24,k=this.n31,q=this.n32,w=this.n33,v=this.n34,x=this.n41,m=this.n42,y=this.n43,B=this.n44;return d*j*q*x-c*l*q*x-d*g*w*x+b*l*w*x+c*g*v*x-b*j*v*x-d*j*k*m+c*l*k*m+d*f*w*m-a*l*w*m-c*f*v*m+a*j*v*m+d*g*k*y-b*l*k*y-d*f*q*y+a*l*q*y+b*f*v*y-a*g*v*y-c*g*k*B+b*j*k*B+c*f*q*B-a*j*q*B-b*f*w*B+a*g*w*B},transpose:function(){function a(b,c,d){var f=b[c];b[c]=b[d];b[d]=f}a(this,"n21","n12");a(this,"n31",
"n13");a(this,"n32","n23");a(this,"n41","n14");a(this,"n42","n24");a(this,"n43","n34");return this},clone:function(){var a=new m4;a.n11=this.n11;a.n12=this.n12;a.n13=this.n13;a.n14=this.n14;a.n21=this.n21;a.n22=this.n22;a.n23=this.n23;a.n24=this.n24;a.n31=this.n31;a.n32=this.n32;a.n33=this.n33;a.n34=this.n34;a.n41=this.n41;a.n42=this.n42;a.n43=this.n43;a.n44=this.n44;return a},flatten:function(){var a=this.flat;a[0]=this.n11;a[1]=this.n21;a[2]=this.n31;a[3]=this.n41;a[4]=this.n12;a[5]=
this.n22;a[6]=this.n32;a[7]=this.n42;a[8]=this.n13;a[9]=this.n23;a[10]=this.n33;a[11]=this.n43;a[12]=this.n14;a[13]=this.n24;a[14]=this.n34;a[15]=this.n44;return a},flattenToArray:function(a){a[0]=this.n11;a[1]=this.n21;a[2]=this.n31;a[3]=this.n41;a[4]=this.n12;a[5]=this.n22;a[6]=this.n32;a[7]=this.n42;a[8]=this.n13;a[9]=this.n23;a[10]=this.n33;a[11]=this.n43;a[12]=this.n14;a[13]=this.n24;a[14]=this.n34;a[15]=this.n44;return a},setTranslation:function(a,b,c){this.set(1,0,0,a,0,1,0,b,0,0,1,c,0,0,0,
1);return this},setScale:function(a,b,c){this.set(a,0,0,0,0,b,0,0,0,0,c,0,0,0,0,1);return this},setRotX:function(a){var b=Math.cos(a);a=Math.sin(a);this.set(1,0,0,0,0,b,-a,0,0,a,b,0,0,0,0,1);return this},setRotY:function(a){var b=Math.cos(a);a=Math.sin(a);this.set(b,0,a,0,0,1,0,0,-a,0,b,0,0,0,0,1);return this},setRotZ:function(a){var b=Math.cos(a);a=Math.sin(a);this.set(b,-a,0,0,a,b,0,0,0,0,1,0,0,0,0,1);return this},setRotAxis:function(a,b){var c=Math.cos(b),d=Math.sin(b),f=1-c,g=a.x,j=a.y,l=a.z,
k=f*g,q=f*j;this.set(k*g+c,k*j-d*l,k*l+d*j,0,k*j+d*l,q*j+c,q*l-d*g,0,k*l-d*j,q*l+d*g,f*l*l+c,0,0,0,0,1);return this},toString:function(){return"| "+this.n11+" "+this.n12+" "+this.n13+" "+this.n14+" |\n| "+this.n21+" "+this.n22+" "+this.n23+" "+this.n24+" |\n| "+this.n31+" "+this.n32+" "+this.n33+" "+this.n34+" |\n| "+this.n41+" "+this.n42+" "+this.n43+" "+this.n44+" |"}};m4.translationMatrix=function(a,b,c){var d=new m4;d.setTranslation(a,b,c);return d};
m4.sCMatrix=function(a,b,c){var d=new m4;d.setScale(a,b,c);return d};m4.rtXMatrix=function(a){var b=new m4;b.setRotX(a);return b};m4.rtYMatrix=function(a){var b=new m4;b.setRotY(a);return b};m4.rtZMatrix=function(a){var b=new m4;b.setRotZ(a);return b};m4.rtAxisAngleMatrix=function(a,b){var c=new m4;c.setRotAxis(a,b);return c};
m4.makeInvert=function(a){var b=a.n11,c=a.n12,d=a.n13,f=a.n14,g=a.n21,j=a.n22,l=a.n23,k=a.n24,q=a.n31,w=a.n32,v=a.n33,x=a.n34,m=a.n41,y=a.n42,B=a.n43,A=a.n44,t=new m4;t.n11=l*x*y-k*v*y+k*w*B-j*x*B-l*w*A+j*v*A;t.n12=f*v*y-d*x*y-f*w*B+c*x*B+d*w*A-c*v*A;t.n13=d*k*y-f*l*y+f*j*B-c*k*B-d*j*A+c*l*A;t.n14=f*l*w-d*k*w-f*j*v+c*k*v+d*j*x-c*l*x;t.n21=k*v*m-l*x*m-k*q*B+g*x*B+l*q*A-g*v*A;t.n22=d*x*m-f*v*m+f*q*B-b*x*B-d*q*A+b*v*A;t.n23=f*l*m-d*k*m-f*g*B+b*k*B+d*g*A-b*l*A;t.n24=d*k*q-f*l*q+
f*g*v-b*k*v-d*g*x+b*l*x;t.n31=j*x*m-k*w*m+k*q*y-g*x*y-j*q*A+g*w*A;t.n32=f*w*m-c*x*m-f*q*y+b*x*y+c*q*A-b*w*A;t.n33=d*k*m-f*j*m+f*g*y-b*k*y-c*g*A+b*j*A;t.n34=f*j*q-c*k*q-f*g*w+b*k*w+c*g*x-b*j*x;t.n41=l*w*m-j*v*m-l*q*y+g*v*y+j*q*B-g*w*B;t.n42=c*v*m-d*w*m+d*q*y-b*v*y-c*q*B+b*w*B;t.n43=d*j*m-c*l*m-d*g*y+b*l*y+c*g*B-b*j*B;t.n44=c*l*q-d*j*q+d*g*w-b*l*w-c*g*v+b*j*v;t.ms(1/a.determinant());return t};
m4.makeInvert3x3=function(a){var b=a.m33,c=b.m,d=a.n33*a.n22-a.n32*a.n23,f=-a.n33*a.n21+a.n31*a.n23,g=a.n32*a.n21-a.n31*a.n22,j=-a.n33*a.n12+a.n32*a.n13,l=a.n33*a.n11-a.n31*a.n13,k=-a.n32*a.n11+a.n31*a.n12,q=a.n23*a.n12-a.n22*a.n13,w=-a.n23*a.n11+a.n21*a.n13,v=a.n22*a.n11-a.n21*a.n12;a=a.n11*d+a.n21*j+a.n31*q;if(a==0)throw"matrix not invertible";a=1/a;c[0]=a*d;c[1]=a*f;c[2]=a*g;c[3]=a*j;c[4]=a*l;c[5]=a*k;c[6]=a*q;c[7]=a*w;c[8]=a*v;return b};
m4.makeFrustum=function(a,b,c,d,f,g){var j,l,k;j=new m4;l=2*f/(b-a);k=2*f/(d-c);a=(b+a)/(b-a);c=(d+c)/(d-c);d=-(g+f)/(g-f);f=-2*g*f/(g-f);j.n11=l;j.n12=0;j.n13=a;j.n14=0;j.n21=0;j.n22=k;j.n23=c;j.n24=0;j.n31=0;j.n32=0;j.n33=d;j.n34=f;j.n41=0;j.n42=0;j.n43=-1;j.n44=0;return j};m4.makePerspective=function(a,b,c,d){var f;a=c*Math.tan(a*Math.PI/360);f=-a;return m4.makeFrustum(f*b,a*b,f,a,c,d)};
m4.makeOrtho=function(a,b,c,d,f,g){var j,l,k,q;j=new m4;l=b-a;k=c-d;q=g-f;a=(b+a)/l;c=(c+d)/k;f=(g+f)/q;j.n11=2/l;j.n12=0;j.n13=0;j.n14=-a;j.n21=0;j.n22=2/k;j.n23=0;j.n24=-c;j.n31=0;j.n32=0;j.n33=-2/q;j.n34=-f;j.n41=0;j.n42=0;j.n43=0;j.n44=1;return j};m4.__tmpVec1=new v3;m4.__tmpVec2=new v3;m4.__tmpVec3=new v3;
Vertex=function(a,b){this.ppos=a||new v3;this.pposWorld=new v3;this.psc=new Vector4;this.normal=b||new v3;this.normalWorld=new v3;this.normalScreen=new v3;this.tangent=new Vector4;this.__vs=true};Vertex.prototype={toString:function(){return"Vertex ( ppos: "+this.ppos+", normal: "+this.normal+" )"}};
Face3=function(a,b,c,d,f){this.a=a;this.b=b;this.c=c;this.centroid=new v3;this.normal=d instanceof v3?d:new v3;this.vns=d instanceof Array?d:[];this.mTs=f instanceof Array?f:[f]};Face3.prototype={toString:function(){return"Face3 ( "+this.a+", "+this.b+", "+this.c+" )"}};
Face4=function(a,b,c,d,f,g){this.a=a;this.b=b;this.c=c;this.d=d;this.centroid=new v3;this.normal=f instanceof v3?f:new v3;this.vns=f instanceof Array?f:[];this.mTs=g instanceof Array?g:[g]};Face4.prototype={toString:function(){return"Face4 ( "+this.a+", "+this.b+", "+this.c+" "+this.d+" )"}};UV=function(a,b){this.u=a||0;this.v=b||0};
UV.prototype={cy:function(a){this.u=a.u;this.v=a.v},toString:function(){return"UV ("+this.u+", "+this.v+")"}};GG=function(){this.vts=[];this.faces=[];this.uvs=[];this.uvs2=[];this.colors=[];this.bS=this.boundingBox=null;this.gGChunks={};this.hasTangents=false};
GG.prototype={cMpCentroids:function(){var a,b,c;a=0;for(b=this.faces.length;a<b;a++){c=this.faces[a];c.centroid.set(0,0,0);if(c instanceof Face3){c.centroid.aS(this.vts[c.a].ppos);c.centroid.aS(this.vts[c.b].ppos);c.centroid.aS(this.vts[c.c].ppos);c.centroid.divideScalar(3)}else if(c instanceof Face4){c.centroid.aS(this.vts[c.a].ppos);c.centroid.aS(this.vts[c.b].ppos);c.centroid.aS(this.vts[c.c].ppos);
c.centroid.aS(this.vts[c.d].ppos);c.centroid.divideScalar(4)}}},cMpFaceNormals:function(a){var b,c,d,f,g,j,l=new v3,k=new v3;d=0;for(f=this.vts.length;d<f;d++){g=this.vts[d];g.normal.set(0,0,0)}d=0;for(f=this.faces.length;d<f;d++){g=this.faces[d];if(a&&g.vns.length){l.set(0,0,0);b=0;for(c=g.normal.length;b<c;b++)l.aS(g.vns[b]);l.divideScalar(3)}else{b=this.vts[g.a];c=this.vts[g.b];j=this.vts[g.c];l.sub(j.ppos,
c.ppos);k.sub(b.ppos,c.ppos);l.crossSelf(k)}l.isZero()||l.normalize();g.normal.cy(l)}},cMpVertexNormals:function(){var a,b,c,d;if(this.__tmpVertices==undefined){d=this.__tmpVertices=Array(this.vts.length);a=0;for(b=this.vts.length;a<b;a++)d[a]=new v3;a=0;for(b=this.faces.length;a<b;a++){c=this.faces[a];if(c instanceof Face3)c.vns=[new v3,new v3,new v3];else if(c instanceof Face4)c.vns=[new v3,
new v3,new v3,new v3]}}else{d=this.__tmpVertices;a=0;for(b=this.vts.length;a<b;a++)d[a].set(0,0,0)}a=0;for(b=this.faces.length;a<b;a++){c=this.faces[a];if(c instanceof Face3){d[c.a].aS(c.normal);d[c.b].aS(c.normal);d[c.c].aS(c.normal)}else if(c instanceof Face4){d[c.a].aS(c.normal);d[c.b].aS(c.normal);d[c.c].aS(c.normal);d[c.d].aS(c.normal)}}a=0;for(b=this.vts.length;a<b;a++)d[a].normalize();a=0;for(b=this.faces.length;a<
b;a++){c=this.faces[a];if(c instanceof Face3){c.vns[0].cy(d[c.a]);c.vns[1].cy(d[c.b]);c.vns[2].cy(d[c.c])}else if(c instanceof Face4){c.vns[0].cy(d[c.a]);c.vns[1].cy(d[c.b]);c.vns[2].cy(d[c.c]);c.vns[3].cy(d[c.d])}}},cMpTangents:function(){function a(J,E,Y,M,X,h,o){g=J.vts[E].ppos;j=J.vts[Y].ppos;l=J.vts[M].ppos;k=f[X];q=f[h];w=f[o];v=j.x-g.x;x=l.x-g.x;m=j.y-g.y;y=l.y-g.y;
B=j.z-g.z;A=l.z-g.z;t=q.u-k.u;I=w.u-k.u;D=q.v-k.v;e=w.v-k.v;P=1/(t*e-I*D);L.set((e*v-D*x)*P,(e*m-D*y)*P,(e*B-D*A)*P);T.set((t*x-I*v)*P,(t*y-I*m)*P,(t*A-I*B)*P);U[E].aS(L);U[Y].aS(L);U[M].aS(L);F[E].aS(T);F[Y].aS(T);F[M].aS(T)}var b,c,d,f,g,j,l,k,q,w,v,x,m,y,B,A,t,I,D,e,P,U=[],F=[],L=new v3,T=new v3,N=new v3,S=new v3,R=new v3;b=0;for(c=this.vts.length;b<c;b++){U[b]=new v3;F[b]=new v3}b=0;
for(c=this.faces.length;b<c;b++){d=this.faces[b];f=this.uvs[b];if(d instanceof Face3){a(this,d.a,d.b,d.c,0,1,2);this.vts[d.a].normal.cy(d.vns[0]);this.vts[d.b].normal.cy(d.vns[1]);this.vts[d.c].normal.cy(d.vns[2])}else if(d instanceof Face4){a(this,d.a,d.b,d.c,0,1,2);a(this,d.a,d.b,d.d,0,1,3);this.vts[d.a].normal.cy(d.vns[0]);this.vts[d.b].normal.cy(d.vns[1]);this.vts[d.c].normal.cy(d.vns[2]);
this.vts[d.d].normal.cy(d.vns[3])}}b=0;for(c=this.vts.length;b<c;b++){R.cy(this.vts[b].normal);d=U[b];N.cy(d);N.subSelf(R.ms(R.dot(d))).normalize();S.cross(this.vts[b].normal,d);d=S.dot(F[b]);d=d<0?-1:1;this.vts[b].tangent.set(N.x,N.y,N.z,d)}this.hasTangents=true},cMpBoundingBox:function(){var a;if(this.vts.length>0){this.boundingBox={x:[this.vts[0].ppos.x,this.vts[0].ppos.x],y:[this.vts[0].ppos.y,this.vts[0].ppos.y],
z:[this.vts[0].ppos.z,this.vts[0].ppos.z]};for(var b=1,c=this.vts.length;b<c;b++){a=this.vts[b];if(a.ppos.x<this.boundingBox.x[0])this.boundingBox.x[0]=a.ppos.x;else if(a.ppos.x>this.boundingBox.x[1])this.boundingBox.x[1]=a.ppos.x;if(a.ppos.y<this.boundingBox.y[0])this.boundingBox.y[0]=a.ppos.y;else if(a.ppos.y>this.boundingBox.y[1])this.boundingBox.y[1]=a.ppos.y;if(a.ppos.z<this.boundingBox.z[0])this.boundingBox.z[0]=a.ppos.z;else if(a.ppos.z>
this.boundingBox.z[1])this.boundingBox.z[1]=a.ppos.z}}},cMpBoundingSS:function(){for(var a=this.bS===null?0:this.bS.radius,b=0,c=this.vts.length;b<c;b++)a=Math.max(a,this.vts[b].ppos.length());this.bS={radius:a}},sortFacesByMt:function(){function a(w){var v=[];b=0;for(c=w.length;b<c;b++)w[b]==undefined?v.push("undefined"):v.push(w[b].toString());return v.join("_")}var b,c,d,f,g,j,l,k,q={};d=0;for(f=this.faces.length;d<f;d++){g=this.faces[d];
j=g.mTs;l=a(j);if(q[l]==undefined)q[l]={hash:l,counter:0};k=q[l].hash+"_"+q[l].counter;if(this.gGChunks[k]==undefined)this.gGChunks[k]={faces:[],mTs:j,vts:0};g=g instanceof Face3?3:4;if(this.gGChunks[k].vts+g>65535){q[l].counter+=1;k=q[l].hash+"_"+q[l].counter;if(this.gGChunks[k]==undefined)this.gGChunks[k]={faces:[],mTs:j,vts:0}}this.gGChunks[k].faces.push(d);this.gGChunks[k].vts+=g}},toString:function(){return"GG ( vts: "+
this.vts+", faces: "+this.faces+", uvs: "+this.uvs+" )"}};
Camera=function(a,b,c,d){this.fov=a;this.aspect=b;this.near=c;this.far=d;this.ppos=new v3;this.target={ppos:new v3};this.aum=true;this.pM=null;this.matrix=new m4;this.up=new v3(0,1,0);this.tmpVec=new v3;this.translateX=function(f){this.tmpVec.sub(this.target.ppos,this.ppos).normalize().ms(f);this.tmpVec.crossSelf(this.up);this.ppos.aS(this.tmpVec);this.target.ppos.aS(this.tmpVec)};
this.translateZ=function(f){this.tmpVec.sub(this.target.ppos,this.ppos).normalize().ms(f);this.ppos.subSelf(this.tmpVec);this.target.ppos.subSelf(this.tmpVec)};this.um=function(){this.matrix.lookAt(this.ppos,this.target.ppos,this.up)};this.updateProjectionMatrix=function(){this.pM=m4.makePerspective(this.fov,this.aspect,this.near,this.far)};this.updateProjectionMatrix()};
Camera.prototype={toString:function(){return"Camera ( "+this.ppos+", "+this.target.ppos+" )"}};Light=function(a){this.color=new Color(a)};AmbientLight=function(a){Light.call(this,a)};AmbientLight.prototype=new Light;AmbientLight.prototype.constructor=AmbientLight;DirectionalLight=function(a,b){Light.call(this,a);this.ppos=new v3(0,1,0);this.intensity=b||1};DirectionalLight.prototype=new Light;
DirectionalLight.prototype.constructor=DirectionalLight;PointLight=function(a,b){Light.call(this,a);this.ppos=new v3;this.intensity=b||1};PointLight.prototype=new Light;PointLight.prototype.constructor=PointLight;
oB3D=function(){this.id=oB3DCounter.value++;this.ppos=new v3;this.rt=new v3;this.sC=new v3(1,1,1);this.matrix=new m4;this.matrixWorld=new m4;this.rtMatrix=new m4;this.tmpMatrix=new m4;this.screen=new v3;this.vs=this.aum=true;this.children=[]};
oB3D.prototype={addChild:function(a){this.children.indexOf(a)===-1&&this.children.push(a)},removeChild:function(a){a=this.children.indexOf(a);a!==-1&&this.children.splice(a,1)},um:function(){var a=this.ppos,b=this.rt,c=this.sC,d=this.matrix,f=this.rtMatrix,g=this.tmpMatrix;d.setTranslation(a.x,a.y,a.z);f.setRotX(b.x);b.y!=0&&f.mS(g.setRotY(b.y));b.z!=0&&f.mS(g.setRotZ(b.z));d.mS(f);if(c.x!=0||c.y!=0||c.z!=0)d.mS(g.setScale(c.x,
c.y,c.z))}};oB3DCounter={value:0};Line=function(a,b,c){oB3D.call(this);this.gG=a;this.mTs=b instanceof Array?b:[b];this.type=c!=undefined?c:LineStrip};LineStrip=0;LinePieces=1;Line.prototype=new oB3D;Line.prototype.constructor=Line;
Mesh=function(a,b){oB3D.call(this);this.gG=a;this.mTs=b instanceof Array?b:[b];this.overdraw=this.doubleSided=this.flipSided=false;this.gG.bS||this.gG.cMpBoundingSS()};Mesh.prototype=new oB3D;Mesh.prototype.constructor=Mesh;FlatShading=0;SmoothShading=1;NormalBlending=0;AdditiveBlending=1;SubtractiveBlending=2;BillboardBlending=3;
LineBasicMt=function(a){this.id=LineBasicMtCounter.value++;this.color=new Color(16777215);this.op=1;this.blending=NormalBlending;this.depth_test=true;this.lw=1;this.linejoin=this.linecap="round";this.vertex_colors=false;if(a){a.color!==undefined&&this.color.setHex(a.color);if(a.op!==undefined)this.op=a.op;if(a.blending!==undefined)this.blending=a.blending;if(a.depth_test!==undefined)this.depth_test=a.depth_test;if(a.lw!==undefined)this.lw=
a.lw;if(a.linecap!==undefined)this.linecap=a.linecap;if(a.linejoin!==undefined)this.linejoin=a.linejoin;if(a.vertex_colors!==undefined)this.vertex_colors=a.vertex_colors}};
LineBasicMt.prototype={toString:function(){return"LineBasicMt (<br/>id: "+this.id+"<br/>color: "+this.color+"<br/>op: "+this.op+"<br/>blending: "+this.blending+"<br/>depth_test: "+this.depth_test+"<br/>lw: "+this.lw+"<br/>linecap: "+this.linecap+"<br/>linejoin: "+this.linejoin+"<br/>vertex_colors: "+this.vertex_colors+"<br/>)"}};LineBasicMtCounter={value:0};
mBm=function(a){this.id=mBmCounter.value++;this.color=new Color(16777215);this.op=1;this.env_map=this.light_map=this.map=null;this.combine=MultiplyOperation;this.rfl=1;this.refraction_ratio=0.98;this.fog=true;this.shading=SmoothShading;this.blending=NormalBlending;this.depth_test=true;this.wf=false;this.wf_lw=1;this.wf_linejoin=this.wf_linecap="round";this.vertex_colors=false;if(a){a.color!==
undefined&&this.color.setHex(a.color);if(a.op!==undefined)this.op=a.op;if(a.map!==undefined)this.map=a.map;if(a.light_map!==undefined)this.light_map=a.light_map;if(a.env_map!==undefined)this.env_map=a.env_map;if(a.combine!==undefined)this.combine=a.combine;if(a.rfl!==undefined)this.rfl=a.rfl;if(a.refraction_ratio!==undefined)this.refraction_ratio=a.refraction_ratio;if(a.fog!==undefined)this.fog=a.fog;if(a.shading!==undefined)this.shading=a.shading;if(a.blending!==
undefined)this.blending=a.blending;if(a.depth_test!==undefined)this.depth_test=a.depth_test;if(a.wf!==undefined)this.wf=a.wf;if(a.wf_lw!==undefined)this.wf_lw=a.wf_lw;if(a.wf_linecap!==undefined)this.wf_linecap=a.wf_linecap;if(a.wf_linejoin!==undefined)this.wf_linejoin=a.wf_linejoin;if(a.vertex_colors!==undefined)this.vertex_colors=a.vertex_colors}};
mBm.prototype={toString:function(){return"mBm (<br/>id: "+this.id+"<br/>color: "+this.color+"<br/>op: "+this.op+"<br/>map: "+this.map+"<br/>light_map: "+this.light_map+"<br/>env_map: "+this.env_map+"<br/>combine: "+this.combine+"<br/>rfl: "+this.rfl+"<br/>refraction_ratio: "+this.refraction_ratio+"<br/>blending: "+this.blending+"<br/>depth_test: "+this.depth_test+"<br/>wf: "+this.wf+"<br/>wf_lw: "+this.wf_lw+
"<br/>wf_linecap: "+this.wf_linecap+"<br/>wf_linejoin: "+this.wf_linejoin+"<br/>vertex_colors: "+this.vertex_colors+"<br/>)"}};mBmCounter={value:0};
mLm=function(a){this.id=mLmCounter.value++;this.color=new Color(16777215);this.op=1;this.env_map=this.light_map=this.map=null;this.combine=MultiplyOperation;this.rfl=1;this.refraction_ratio=0.98;this.fog=true;this.shading=SmoothShading;this.blending=NormalBlending;this.depth_test=true;this.wf=false;this.wf_lw=1;this.wf_linejoin=this.wf_linecap="round";this.vertex_colors=false;if(a){a.color!==
undefined&&this.color.setHex(a.color);if(a.op!==undefined)this.op=a.op;if(a.map!==undefined)this.map=a.map;if(a.light_map!==undefined)this.light_map=a.light_map;if(a.env_map!==undefined)this.env_map=a.env_map;if(a.combine!==undefined)this.combine=a.combine;if(a.rfl!==undefined)this.rfl=a.rfl;if(a.refraction_ratio!==undefined)this.refraction_ratio=a.refraction_ratio;if(a.fog!==undefined)this.fog=a.fog;if(a.shading!==undefined)this.shading=a.shading;if(a.blending!==
undefined)this.blending=a.blending;if(a.depth_test!==undefined)this.depth_test=a.depth_test;if(a.wf!==undefined)this.wf=a.wf;if(a.wf_lw!==undefined)this.wf_lw=a.wf_lw;if(a.wf_linecap!==undefined)this.wf_linecap=a.wf_linecap;if(a.wf_linejoin!==undefined)this.wf_linejoin=a.wf_linejoin;if(a.vertex_colors!==undefined)this.vertex_colors=a.vertex_colors}};
mLm.prototype={toString:function(){return"mLm (<br/>id: "+this.id+"<br/>color: "+this.color+"<br/>op: "+this.op+"<br/>map: "+this.map+"<br/>light_map: "+this.light_map+"<br/>env_map: "+this.env_map+"<br/>combine: "+this.combine+"<br/>rfl: "+this.rfl+"<br/>refraction_ratio: "+this.refraction_ratio+"<br/>shading: "+this.shading+"<br/>blending: "+this.blending+"<br/>depth_test: "+this.depth_test+"<br/>wf: "+this.wf+
"<br/>wf_lw: "+this.wf_lw+"<br/>wf_linecap: "+this.wf_linecap+"<br/>wf_linejoin: "+this.wf_linejoin+"<br/>vertex_colors: "+this.vertex_colors+"<br/> )"}};mLmCounter={value:0};
mQm=function(a){this.id=mQmCounter.value++;this.color=new Color(16777215);this.ambient=new Color(328965);this.specular=new Color(1118481);this.shininess=30;this.op=1;this.env_map=this.light_map=this.map=null;this.combine=MultiplyOperation;this.rfl=1;this.refraction_ratio=0.98;this.fog=true;this.shading=SmoothShading;this.blending=NormalBlending;this.depth_test=true;this.wf=false;this.wf_lw=
1;this.wf_linejoin=this.wf_linecap="round";this.vertex_colors=false;if(a){if(a.color!==undefined)this.color=new Color(a.color);if(a.ambient!==undefined)this.ambient=new Color(a.ambient);if(a.specular!==undefined)this.specular=new Color(a.specular);if(a.shininess!==undefined)this.shininess=a.shininess;if(a.op!==undefined)this.op=a.op;if(a.light_map!==undefined)this.light_map=a.light_map;if(a.map!==undefined)this.map=a.map;if(a.env_map!==undefined)this.env_map=
a.env_map;if(a.combine!==undefined)this.combine=a.combine;if(a.rfl!==undefined)this.rfl=a.rfl;if(a.refraction_ratio!==undefined)this.refraction_ratio=a.refraction_ratio;if(a.fog!==undefined)this.fog=a.fog;if(a.shading!==undefined)this.shading=a.shading;if(a.blending!==undefined)this.blending=a.blending;if(a.depth_test!==undefined)this.depth_test=a.depth_test;if(a.wf!==undefined)this.wf=a.wf;if(a.wf_lw!==undefined)this.wf_lw=
a.wf_lw;if(a.wf_linecap!==undefined)this.wf_linecap=a.wf_linecap;if(a.wf_linejoin!==undefined)this.wf_linejoin=a.wf_linejoin;if(a.vertex_colors!==undefined)this.vertex_colors=a.vertex_colors}};
mQm.prototype={toString:function(){return"mQm (<br/>id: "+this.id+"<br/>color: "+this.color+"<br/>ambient: "+this.ambient+"<br/>specular: "+this.specular+"<br/>shininess: "+this.shininess+"<br/>op: "+this.op+"<br/>map: "+this.map+"<br/>env_map: "+this.env_map+"<br/>combine: "+this.combine+"<br/>rfl: "+this.rfl+"<br/>refraction_ratio: "+this.refraction_ratio+"<br/>shading: "+this.shading+"<br/>blending: "+this.blending+"<br/>depth_test: "+
this.depth_test+"<br/>wf: "+this.wf+"<br/>wf_lw: "+this.wf_lw+"<br/>wf_linecap: "+this.wf_linecap+"<br/>wf_linejoin: "+this.wf_linejoin+"<br/>vertex_colors: "+this.vertex_colors+"<br/>)"}};mQmCounter={value:0};
MeshDepthMt=function(a){this.id=MeshDepthMtCounter.value++;this.op=1;this.shading=SmoothShading;this.blending=NormalBlending;this.depth_test=true;this.wf=false;this.wf_lw=1;if(a){if(a.op!==undefined)this.op=a.op;if(a.shading!==undefined)this.shading=a.shading;if(a.blending!==undefined)this.blending=a.blending;if(a.depth_test!==undefined)this.depth_test=a.depth_test;if(a.wf!==undefined)this.wf=a.wf;if(a.wf_lw!==
undefined)this.wf_lw=a.wf_lw}};MeshDepthMt.prototype={toString:function(){return"MeshDepthMt (<br/>id: "+this.id+"<br/>op: "+this.op+"<br/>blending: "+this.blending+"<br/>depth_test: "+this.depth_test+"<br/>wf: "+this.wf+"<br/>wf_lw: "+this.wf_lw+"<br/>)"}};MeshDepthMtCounter={value:0};
MeshNormalMt=function(a){this.id=MeshNormalMtCounter.value++;this.op=1;this.shading=FlatShading;this.blending=NormalBlending;this.depth_test=true;this.wf=false;this.wf_lw=1;if(a){if(a.op!==undefined)this.op=a.op;if(a.shading!==undefined)this.shading=a.shading;if(a.blending!==undefined)this.blending=a.blending;if(a.depth_test!==undefined)this.depth_test=a.depth_test;if(a.wf!==undefined)this.wf=a.wf;if(a.wf_lw!==
undefined)this.wf_lw=a.wf_lw}};MeshNormalMt.prototype={toString:function(){return"MeshNormalMt (<br/>id: "+this.id+"<br/>op: "+this.op+"<br/>blending: "+this.blending+"<br/>depth_test: "+this.depth_test+"<br/>wf: "+this.wf+"<br/>wf_lw: "+this.wf_lw+"<br/>)"}};MeshNormalMtCounter={value:0};MeshFaceMt=function(){};MeshFaceMt.prototype={toString:function(){return"MeshFaceMt"}};
MeshShaderMt=function(a){this.id=MeshShaderMtCounter.value++;this.vertex_shader=this.fragment_shader="void main() {}";this.uniforms={};this.op=1;this.shading=SmoothShading;this.blending=NormalBlending;this.depth_test=true;this.wf=false;this.wf_lw=1;this.wf_linejoin=this.wf_linecap="round";this.vertex_colors=false;if(a){if(a.fragment_shader!==undefined)this.fragment_shader=a.fragment_shader;if(a.vertex_shader!==undefined)this.vertex_shader=
a.vertex_shader;if(a.uniforms!==undefined)this.uniforms=a.uniforms;if(a.op!==undefined)this.op=a.op;if(a.shading!==undefined)this.shading=a.shading;if(a.blending!==undefined)this.blending=a.blending;if(a.depth_test!==undefined)this.depth_test=a.depth_test;if(a.wf!==undefined)this.wf=a.wf;if(a.wf_lw!==undefined)this.wf_lw=a.wf_lw;if(a.wf_linecap!==undefined)this.wf_linecap=a.wf_linecap;if(a.wf_linejoin!==
undefined)this.wf_linejoin=a.wf_linejoin;if(a.vertex_colors!==undefined)this.vertex_colors=a.vertex_colors}};
MeshShaderMt.prototype={toString:function(){return"MeshShaderMt (<br/>id: "+this.id+"<br/>blending: "+this.blending+"<br/>depth_test: "+this.depth_test+"<br/>wf: "+this.wf+"<br/>wf_lw: "+this.wf_lw+"<br/>wf_linecap: "+this.wf_linecap+"<br/>wf_linejoin: "+this.wf_linejoin+"<br/>vertex_colors: "+this.vertex_colors+"<br/>)"}};MeshShaderMtCounter={value:0};
ParticleBasicMt=function(a){this.id=ParticleBasicMtCounter.value++;this.color=new Color(16777215);this.op=1;this.map=null;this.size=1;this.blending=NormalBlending;this.depth_test=true;this.offset=new Vector2;this.vertex_colors=false;if(a){a.color!==undefined&&this.color.setHex(a.color);if(a.op!==undefined)this.op=a.op;if(a.map!==undefined)this.map=a.map;if(a.size!==undefined)this.size=a.size;if(a.blending!==undefined)this.blending=a.blending;
if(a.depth_test!==undefined)this.depth_test=a.depth_test;if(a.vertex_colors!==undefined)this.vertex_colors=a.vertex_colors}};ParticleBasicMt.prototype={toString:function(){return"ParticleBasicMt (<br/>id: "+this.id+"<br/>color: "+this.color+"<br/>op: "+this.op+"<br/>map: "+this.map+"<br/>size: "+this.size+"<br/>blending: "+this.blending+"<br/>depth_test: "+this.depth_test+"<br/>vertex_colors: "+this.vertex_colors+"<br/>)"}};ParticleBasicMtCounter={value:0};
Texture=function(a,b,c,d,f,g){this.image=a;this.mapping=b!==undefined?b:new UVMapping;this.wrap_s=c!==undefined?c:ClampToEdgeWrapping;this.wrap_t=d!==undefined?d:ClampToEdgeWrapping;this.mag_filter=f!==undefined?f:LinearFilter;this.min_filter=g!==undefined?g:LinearMipMapLinearFilter};
Texture.prototype={clone:function(){return new Texture(this.image,this.mapping,this.wrap_s,this.wrap_t,this.mag_filter,this.min_filter)},toString:function(){return"Texture (<br/>image: "+this.image+"<br/>wrap_s: "+this.wrap_s+"<br/>wrap_t: "+this.wrap_t+"<br/>mag_filter: "+this.mag_filter+"<br/>min_filter: "+this.min_filter+"<br/>)"}};MultiplyOperation=0;MixOperation=1;RepeatWrapping=0;ClampToEdgeWrapping=1;MirroredRepeatWrapping=2;
NearestFilter=3;NearestMipMapNearestFilter=4;NearestMipMapLinearFilter=5;LinearFilter=6;LinearMipMapNearestFilter=7;LinearMipMapLinearFilter=8;ByteType=9;UnsignedByteType=10;ShortType=11;UnsignedShortType=12;IntType=13;UnsignedIntType=14;FloatType=15;AlphaFormat=16;RGBFormat=17;RGBAFormat=18;LuminanceFormat=19;LuminanceAlphaFormat=20;
var Uniforms={clone:function(a){var b,c,d,f={};for(b in a){f[b]={};for(c in a[b]){d=a[b][c];f[b][c]=d instanceof Color||d instanceof v3||d instanceof Texture?d.clone():d}}return f},merge:function(a){var b,c,d,f={};for(b=0;b<a.length;b++){d=this.clone(a[b]);for(c in d)f[c]=d[c]}return f}};UVMapping=function(){};
Scene=function(){this.objects=[];this.lights=[];this.fog=null;this.addoB=function(a){this.objects.indexOf(a)===-1&&this.objects.push(a)};this.removeoB=function(a){a=this.objects.indexOf(a);a!==-1&&this.objects.splice(a,1)};this.addLight=function(a){this.lights.indexOf(a)===-1&&this.lights.push(a)};this.removeLight=function(a){a=this.lights.indexOf(a);a!==-1&&this.lights.splice(a,1)};this.toString=function(){return"Scene ( "+this.objects+" )"}};
FogExp2=function(a,b){this.color=new Color(a);this.density=b||2.5E-4};
Projector=function(){function a(F,L){return L.z-F.z}function b(F,L){var T=0,N=1,S=F.z+F.w,R=L.z+L.w,J=-F.z+F.w,E=-L.z+L.w;if(S>=0&&R>=0&&J>=0&&E>=0)return true;else if(S<0&&R<0||J<0&&E<0)return false;else{if(S<0)T=Math.max(T,S/(S-R));else if(R<0)N=Math.min(N,S/(S-R));if(J<0)T=Math.max(T,J/(J-E));else if(E<0)N=Math.min(N,J/(J-E));if(N<T)return false;else{F.lerpSelf(L,T);L.lerpSelf(F,1-N);return true}}}var c,d,f=[],g,j,l,k=[],q,w,v=[],x,m,y=[],B=new Vector4,A=new Vector4,t=new m4,
I=new m4,D=[],e=new Vector4,P=new Vector4,U;this.projectoBs=function(F,L,T){var N=[],S,R;d=0;t.multiply(L.pM,L.matrix);D[0]=new Vector4(t.n41-t.n11,t.n42-t.n12,t.n43-t.n13,t.n44-t.n14);D[1]=new Vector4(t.n41+t.n11,t.n42+t.n12,t.n43+t.n13,t.n44+t.n14);D[2]=new Vector4(t.n41+t.n21,t.n42+t.n22,t.n43+t.n23,t.n44+t.n24);D[3]=new Vector4(t.n41-t.n21,t.n42-t.n22,t.n43-t.n23,t.n44-t.n24);D[4]=new Vector4(t.n41-t.n31,t.n42-t.n32,t.n43-
t.n33,t.n44-t.n34);D[5]=new Vector4(t.n41+t.n31,t.n42+t.n32,t.n43+t.n33,t.n44+t.n34);L=0;for(S=D.length;L<S;L++){R=D[L];R.divideScalar(Math.sqrt(R.x*R.x+R.y*R.y+R.z*R.z))}S=F.objects;F=0;for(L=S.length;F<L;F++){R=S[F];var J;if(!(J=!R.vs))if(J=R instanceof Mesh){a:{for(var E=R.ppos,Y=-R.gG.bS.radius*Math.max(R.sC.x,Math.max(R.sC.y,R.sC.z)),M=0;M<6;M++){J=D[M].x*E.x+D[M].y*E.y+D[M].z*E.z+D[M].w;if(J<=Y){J=false;break a}}J=true}J=!J}if(!J){c=f[d]=f[d]||
new RenderableoB;B.cy(R.ppos);t.mV3(B);c.object=R;c.z=B.z;N.push(c);d++}}T&&N.sort(a);return N};this.projectScene=function(F,L,T){var N=[],S=L.near,R=L.far,J,E,Y,M,X,h,o,u,n,p,K,H,C,G,z,O;l=w=m=0;L.aum&&L.um();t.multiply(L.pM,L.matrix);h=this.projectoBs(F,L,true);F=0;for(J=h.length;F<J;F++){o=h[F].object;if(o.vs){o.aum&&o.um();u=o.matrix;n=o.rtMatrix;p=o.mTs;K=o.overdraw;if(o instanceof Mesh){H=
o.gG;C=H.vts;E=0;for(Y=C.length;E<Y;E++){G=C[E];G.pposWorld.cy(G.ppos);u.mV3(G.pposWorld);M=G.psc;M.cy(G.pposWorld);t.mV4(M);M.x/=M.w;M.y/=M.w;G.__vs=M.z>S&&M.z<R}H=H.faces;E=0;for(Y=H.length;E<Y;E++){G=H[E];if(G instanceof Face3){M=C[G.a];X=C[G.b];z=C[G.c];if(M.__vs&&X.__vs&&z.__vs)if(o.doubleSided||o.flipSided!=(z.psc.x-M.psc.x)*(X.psc.y-M.psc.y)-(z.psc.y-
M.psc.y)*(X.psc.x-M.psc.x)<0){g=k[l]=k[l]||new RenderableFace3;g.v1.pposWorld.cy(M.pposWorld);g.v2.pposWorld.cy(X.pposWorld);g.v3.pposWorld.cy(z.pposWorld);g.v1.psc.cy(M.psc);g.v2.psc.cy(X.psc);g.v3.psc.cy(z.psc);g.normalWorld.cy(G.normal);n.mV3(g.normalWorld);g.centroidWorld.cy(G.centroid);u.mV3(g.centroidWorld);g.centroidScreen.cy(g.centroidWorld);
t.mV3(g.centroidScreen);z=G.vns;U=g.vnsWorld;M=0;for(X=z.length;M<X;M++){O=U[M]=U[M]||new v3;O.cy(z[M]);n.mV3(O)}g.z=g.centroidScreen.z;g.meshMts=p;g.faceMts=G.mTs;g.overdraw=K;if(o.gG.uvs[E]){g.uvs[0]=o.gG.uvs[E][0];g.uvs[1]=o.gG.uvs[E][1];g.uvs[2]=o.gG.uvs[E][2]}N.push(g);l++}}else if(G instanceof Face4){M=C[G.a];X=C[G.b];z=C[G.c];O=C[G.d];if(M.__vs&&X.__vs&&z.__vs&&O.__vs)if(o.doubleSided||
o.flipSided!=((O.psc.x-M.psc.x)*(X.psc.y-M.psc.y)-(O.psc.y-M.psc.y)*(X.psc.x-M.psc.x)<0||(X.psc.x-z.psc.x)*(O.psc.y-z.psc.y)-(X.psc.y-z.psc.y)*(O.psc.x-z.psc.x)<0)){g=k[l]=k[l]||new RenderableFace3;g.v1.pposWorld.cy(M.pposWorld);g.v2.pposWorld.cy(X.pposWorld);g.v3.pposWorld.cy(O.pposWorld);
g.v1.psc.cy(M.psc);g.v2.psc.cy(X.psc);g.v3.psc.cy(O.psc);g.normalWorld.cy(G.normal);n.mV3(g.normalWorld);g.centroidWorld.cy(G.centroid);u.mV3(g.centroidWorld);g.centroidScreen.cy(g.centroidWorld);t.mV3(g.centroidScreen);g.z=g.centroidScreen.z;g.meshMts=p;g.faceMts=G.mTs;g.overdraw=K;if(o.gG.uvs[E]){g.uvs[0]=o.gG.uvs[E][0];g.uvs[1]=o.gG.uvs[E][1];g.uvs[2]=
o.gG.uvs[E][3]}N.push(g);l++;j=k[l]=k[l]||new RenderableFace3;j.v1.pposWorld.cy(X.pposWorld);j.v2.pposWorld.cy(z.pposWorld);j.v3.pposWorld.cy(O.pposWorld);j.v1.psc.cy(X.psc);j.v2.psc.cy(z.psc);j.v3.psc.cy(O.psc);j.normalWorld.cy(g.normalWorld);j.centroidWorld.cy(g.centroidWorld);j.centroidScreen.cy(g.centroidScreen);j.z=j.centroidScreen.z;j.meshMts=p;j.faceMts=G.mTs;
j.overdraw=K;if(o.gG.uvs[E]){j.uvs[0]=o.gG.uvs[E][1];j.uvs[1]=o.gG.uvs[E][2];j.uvs[2]=o.gG.uvs[E][3]}N.push(j);l++}}}}else if(o instanceof Line){I.multiply(t,u);C=o.gG.vts;G=C[0];G.psc.cy(G.ppos);I.mV4(G.psc);E=1;for(Y=C.length;E<Y;E++){M=C[E];M.psc.cy(M.ppos);I.mV4(M.psc);X=C[E-1];e.cy(M.psc);P.cy(X.psc);if(b(e,P)){e.ms(1/e.w);P.ms(1/
P.w);q=v[w]=v[w]||new RenderableLine;q.v1.psc.cy(e);q.v2.psc.cy(P);q.z=Math.max(e.z,P.z);q.mTs=o.mTs;N.push(q);w++}}}else if(o instanceof Particle){A.set(o.ppos.x,o.ppos.y,o.ppos.z,1);t.mV4(A);A.z/=A.w;if(A.z>0&&A.z<1){x=y[m]=y[m]||new RenderableParticle;x.x=A.x/A.w;x.y=A.y/A.w;x.z=A.z;x.rt=o.rt.z;x.sC.x=o.sC.x*Math.abs(x.x-(A.x+L.pM.n11)/(A.w+L.pM.n14));x.sC.y=o.sC.y*
Math.abs(x.y-(A.y+L.pM.n22)/(A.w+L.pM.n24));x.mTs=o.mTs;N.push(x);m++}}}}T&&N.sort(a);return N};this.unprojectVector=function(F,L){var T=m4.makeInvert(L.matrix);T.mS(m4.makeInvert(L.pM));T.mV3(F);return F}};
WebGLRenderer=function(a){function b(h,o,u){var n,p,K,H=h.vts,C=H.length,G=h.colors,z=G.length,O=h.__vertexArray,W=h.__colorArray,aa=h.__sortArray,ca=h.__dirtyVertices,$=h.__dirtyColors;if(u.sortParticles){S.mS(u.matrixWorld);for(n=0;n<C;n++){p=H[n].ppos;E.cy(p);S.mV3(E);aa[n]=[E.z,n]}aa.sort(function(Z,V){return V[0]-Z[0]});for(n=0;n<C;n++){p=H[aa[n][1]].ppos;K=n*3;O[K]=p.x;O[K+1]=p.y;O[K+2]=p.z}for(n=0;n<z;n++){K=n*3;color=G[aa[n][1]];W[K]=color.r;W[K+
1]=color.g;W[K+2]=color.b}}else{if(ca)for(n=0;n<C;n++){p=H[n].ppos;K=n*3;O[K]=p.x;O[K+1]=p.y;O[K+2]=p.z}if($)for(n=0;n<z;n++){color=G[n];K=n*3;W[K]=color.r;W[K+1]=color.g;W[K+2]=color.b}}if(ca||u.sortParticles){e.bindBuffer(e.ARRAY_BUFFER,h.__webGLVertexBuffer);e.bufferData(e.ARRAY_BUFFER,O,o)}if($||u.sortParticles){e.bindBuffer(e.ARRAY_BUFFER,h.__webGLColorBuffer);e.bufferData(e.ARRAY_BUFFER,W,o)}}function c(h,o){h.fragment_shader=o.fragment_shader;h.vertex_shader=o.vertex_shader;h.uniforms=
Uniforms.clone(o.uniforms)}function d(h,o){if(!h.__webGLVertexBuffer)h.__webGLVertexBuffer=e.createBuffer();if(!h.__webGLNormalBuffer)h.__webGLNormalBuffer=e.createBuffer();if(h.hasPos){e.bindBuffer(e.ARRAY_BUFFER,h.__webGLVertexBuffer);e.bufferData(e.ARRAY_BUFFER,h.pposArray,e.DYNAMIC_DRAW);e.enableVertexAttribArray(o.attributes.ppos);e.vertexAttribPointer(o.attributes.ppos,3,e.FLOAT,false,0,0)}if(h.hasNormal){e.bindBuffer(e.ARRAY_BUFFER,h.__webGLNormalBuffer);e.bufferData(e.ARRAY_BUFFER,
h.normalArray,e.DYNAMIC_DRAW);e.enableVertexAttribArray(o.attributes.normal);e.vertexAttribPointer(o.attributes.normal,3,e.FLOAT,false,0,0)}e.drawArrays(e.TRIANGLES,0,h.count);h.count=0}function f(h){if(F!=h.doubleSided){h.doubleSided?e.disable(e.CULL_FACE):e.enable(e.CULL_FACE);F=h.doubleSided}if(L!=h.flipSided){h.flipSided?e.frontFace(e.CW):e.frontFace(e.CCW);L=h.flipSided}}function g(h){N[0].set(h.n41-h.n11,h.n42-h.n12,h.n43-h.n13,h.n44-h.n14);N[1].set(h.n41+h.n11,h.n42+h.n12,h.n43+h.n13,h.n44+
h.n14);N[2].set(h.n41+h.n21,h.n42+h.n22,h.n43+h.n23,h.n44+h.n24);N[3].set(h.n41-h.n21,h.n42-h.n22,h.n43-h.n23,h.n44-h.n24);N[4].set(h.n41-h.n31,h.n42-h.n32,h.n43-h.n33,h.n44-h.n34);N[5].set(h.n41+h.n31,h.n42+h.n32,h.n43+h.n33,h.n44+h.n34);var o;for(h=0;h<5;h++){o=N[h];o.divideScalar(Math.sqrt(o.x*o.x+o.y*o.y+o.z*o.z))}}function j(h){for(var o=h.matrix,u=-h.gG.bS.radius*Math.max(h.sC.x,Math.max(h.sC.y,h.sC.z)),n=0;n<6;n++){h=N[n].x*o.n14+N[n].y*o.n24+N[n].z*o.n34+N[n].w;
if(h<=u)return false}return true}function l(h,o){h.list[h.count]=o;h.count+=1}function k(h){var o,u,n=h.object,p=h.opaque,K=h.transparent;K.count=0;h=p.count=0;for(o=n.mTs.length;h<o;h++){u=n.mTs[h];u.op&&u.op<1||u.blending!=NormalBlending?l(K,u):l(p,u)}}function q(h){var o,u,n,p,K=h.object,H=h.buffer,C=h.opaque,G=h.transparent;G.count=0;h=C.count=0;for(n=K.mTs.length;h<n;h++){o=K.mTs[h];if(o instanceof MeshFaceMt){o=0;for(u=H.mTs.length;o<
u;o++)if(p=H.mTs[o])p.op&&p.op<1||p.blending!=NormalBlending?l(G,p):l(C,p)}else{p=o;p.op&&p.op<1||p.blending!=NormalBlending?l(G,p):l(C,p)}}}function w(h){var o,u,n,p=h.children;o=0;for(u=p.length;o<u;o++){n=p[o];n.aum&&n.um();n.matrixWorld.multiply(h.matrixWorld,n.matrix);w(n)}}function v(h,o){var u,n,p=o.children;u=0;for(n=p.length;u<n;u++){child=p[u];x(h,child,false);v(h,child)}}function x(h,o,u){var n,p,K;p=o.gG;if(h.__webGLoBsMap[o.id]==
undefined){h.__webGLoBsMap[o.id]={};o._modelViewMatrix=new m4;o._normalMatrixArray=new Float32Array(9);o._modelViewMatrixArray=new Float32Array(16);o._objectMatrixArray=new Float32Array(16);o.matrix.flattenToArray(o._objectMatrixArray)}K=h.__webGLoBsMap[o.id];objlist=h.__webGLoBs;if(o instanceof Mesh){for(n in p.gGChunks){h=p.gGChunks[n];if(!h.__webGLVertexBuffer){var H=h;H.__webGLVertexBuffer=e.createBuffer();H.__webGLNormalBuffer=e.createBuffer();H.__webGLTangentBuffer=
e.createBuffer();H.__webGLColorBuffer=e.createBuffer();H.__webGLUVBuffer=e.createBuffer();H.__webGLUV2Buffer=e.createBuffer();H.__webGLFaceBuffer=e.createBuffer();H.__webGLLineBuffer=e.createBuffer();H=h;var C=o,G=void 0,z=void 0,O=0,W=0,aa=0,ca=C.gG.faces,$=H.faces;G=0;for(z=$.length;G<z;G++){fi=$[G];face=ca[fi];if(face instanceof Face3){O+=3;W+=1;aa+=3}else if(face instanceof Face4){O+=4;W+=2;aa+=4}}H.__vertexArray=new Float32Array(O*3);H.__normalArray=new Float32Array(O*3);H.__tangentArray=
new Float32Array(O*4);H.__colorArray=new Float32Array(O*3);H.__uvArray=new Float32Array(O*2);H.__uv2Array=new Float32Array(O*2);H.__faceArray=new Uint16Array(W*3);H.__lineArray=new Uint16Array(aa*2);z=G=H;var Z=void 0,V=void 0;$=false;O=0;for(ca=C.mTs.length;O<ca;O++){Z=C.mTs[O];if(Z instanceof MeshFaceMt){Z=0;for(V=z.mTs.length;Z<V;Z++)if(z.mTs[Z]&&z.mTs[Z].shading!=undefined&&z.mTs[Z].shading==SmoothShading){$=true;break}}else if(Z&&Z.shading!=
undefined&&Z.shading==SmoothShading){$=true;break}if($)break}G.__needsSmoothNormals=$;H.__webGLFaceCount=W*3;H.__webGLLineCount=aa*2;p.__dirtyVertices=true;p.__dirtyElements=true;p.__dirtyUvs=true;p.__dirtyNormals=true;p.__dirtyTangents=true;p.__dirtyColors=true}if(p.__dirtyVertices||p.__dirtyElements||p.__dirtyUvs||p.__dirtyNormals||p.__dirtyColors||p.__dirtyTangents){H=h;W=e.DYNAMIC_DRAW;var ma=void 0,Q=void 0,qa=void 0,ka=void 0,ra=void 0,da=void 0,ea=void 0,fa=void 0,ua=void 0,ja=V=Z=$=
ca=O=C=z=0,ga=0,ha=H.__vertexArray,wa=H.__uvArray,xa=H.__uv2Array,pa=H.__normalArray,ba=H.__tangentArray,ia=H.__colorArray,sa=H.__faceArray,la=H.__lineArray,Da=H.__needsSmoothNormals,na=o.gG,ya=na.__dirtyVertices,za=na.__dirtyElements,va=na.__dirtyUvs,Aa=na.__dirtyNormals,Ba=na.__dirtyTangents,Ca=na.__dirtyColors,oa=na.vts,Ea=H.faces,Fa=na.faces,Ga=na.uvs,Ha=na.uvs2,ta=na.colors;aa=0;for(G=Ea.length;aa<G;aa++){ma=Ea[aa];Q=Fa[ma];ra=Ga[ma];ma=Ha[ma];qa=Q.vns;ka=Q.normal;if(Q instanceof
Face3){if(ya){da=oa[Q.a].ppos;ea=oa[Q.b].ppos;fa=oa[Q.c].ppos;ha[C]=da.x;ha[C+1]=da.y;ha[C+2]=da.z;ha[C+3]=ea.x;ha[C+4]=ea.y;ha[C+5]=ea.z;ha[C+6]=fa.x;ha[C+7]=fa.y;ha[C+8]=fa.z;C+=9}if(Ca&&ta.length){da=ta[Q.a];ea=ta[Q.b];fa=ta[Q.c];ia[ga]=da.r;ia[ga+1]=da.g;ia[ga+2]=da.b;ia[ga+3]=ea.r;ia[ga+4]=ea.g;ia[ga+5]=ea.b;ia[ga+6]=fa.r;ia[ga+7]=fa.g;ia[ga+8]=fa.b;ga+=9}if(Ba&&na.hasTangents){da=oa[Q.a].tangent;ea=oa[Q.b].tangent;fa=oa[Q.c].tangent;ba[V]=da.x;ba[V+1]=da.y;ba[V+2]=da.z;ba[V+
3]=da.w;ba[V+4]=ea.x;ba[V+5]=ea.y;ba[V+6]=ea.z;ba[V+7]=ea.w;ba[V+8]=fa.x;ba[V+9]=fa.y;ba[V+10]=fa.z;ba[V+11]=fa.w;V+=12}if(Aa)if(qa.length==3&&Da)for(Q=0;Q<3;Q++){ka=qa[Q];pa[Z]=ka.x;pa[Z+1]=ka.y;pa[Z+2]=ka.z;Z+=3}else for(Q=0;Q<3;Q++){pa[Z]=ka.x;pa[Z+1]=ka.y;pa[Z+2]=ka.z;Z+=3}if(va&&ra)for(Q=0;Q<3;Q++){qa=ra[Q];wa[O]=qa.u;wa[O+1]=qa.v;O+=2}if(va&&ma)for(Q=0;Q<3;Q++){ra=ma[Q];xa[ca]=ra.u;xa[ca+1]=ra.v;ca+=2}if(za){sa[$]=z;sa[$+1]=z+1;sa[$+2]=z+2;$+=3;la[ja]=z;la[ja+1]=z+1;la[ja+2]=z;la[ja+3]=z+2;
la[ja+4]=z+1;la[ja+5]=z+2;ja+=6;z+=3}}else if(Q instanceof Face4){if(ya){da=oa[Q.a].ppos;ea=oa[Q.b].ppos;fa=oa[Q.c].ppos;ua=oa[Q.d].ppos;ha[C]=da.x;ha[C+1]=da.y;ha[C+2]=da.z;ha[C+3]=ea.x;ha[C+4]=ea.y;ha[C+5]=ea.z;ha[C+6]=fa.x;ha[C+7]=fa.y;ha[C+8]=fa.z;ha[C+9]=ua.x;ha[C+10]=ua.y;ha[C+11]=ua.z;C+=12}if(Ca&&ta.length){da=ta[Q.a];ea=ta[Q.b];fa=ta[Q.c];ua=ta[Q.d];ia[ga]=da.r;ia[ga+1]=da.g;ia[ga+2]=da.b;ia[ga+3]=ea.r;ia[ga+4]=ea.g;ia[ga+5]=ea.b;ia[ga+6]=fa.r;ia[ga+7]=fa.g;ia[ga+8]=
fa.b;ia[ga+9]=ua.r;ia[ga+10]=ua.g;ia[ga+11]=ua.b;ga+=12}if(Ba&&na.hasTangents){da=oa[Q.a].tangent;ea=oa[Q.b].tangent;fa=oa[Q.c].tangent;Q=oa[Q.d].tangent;ba[V]=da.x;ba[V+1]=da.y;ba[V+2]=da.z;ba[V+3]=da.w;ba[V+4]=ea.x;ba[V+5]=ea.y;ba[V+6]=ea.z;ba[V+7]=ea.w;ba[V+8]=fa.x;ba[V+9]=fa.y;ba[V+10]=fa.z;ba[V+11]=fa.w;ba[V+12]=Q.x;ba[V+13]=Q.y;ba[V+14]=Q.z;ba[V+15]=Q.w;V+=16}if(Aa)if(qa.length==4&&Da)for(Q=0;Q<4;Q++){ka=qa[Q];pa[Z]=ka.x;pa[Z+1]=ka.y;pa[Z+2]=ka.z;Z+=3}else for(Q=0;Q<4;Q++){pa[Z]=ka.x;pa[Z+1]=
ka.y;pa[Z+2]=ka.z;Z+=3}if(va&&ra)for(Q=0;Q<4;Q++){qa=ra[Q];wa[O]=qa.u;wa[O+1]=qa.v;O+=2}if(va&&ma)for(Q=0;Q<4;Q++){ra=ma[Q];xa[ca]=ra.u;xa[ca+1]=ra.v;ca+=2}if(za){sa[$]=z;sa[$+1]=z+1;sa[$+2]=z+2;sa[$+3]=z;sa[$+4]=z+2;sa[$+5]=z+3;$+=6;la[ja]=z;la[ja+1]=z+1;la[ja+2]=z;la[ja+3]=z+3;la[ja+4]=z+1;la[ja+5]=z+2;la[ja+6]=z+2;la[ja+7]=z+3;ja+=8;z+=4}}}if(ya){e.bindBuffer(e.ARRAY_BUFFER,H.__webGLVertexBuffer);e.bufferData(e.ARRAY_BUFFER,ha,W)}if(Ca&&ta.length){e.bindBuffer(e.ARRAY_BUFFER,H.__webGLColorBuffer);
e.bufferData(e.ARRAY_BUFFER,ia,W)}if(Aa){e.bindBuffer(e.ARRAY_BUFFER,H.__webGLNormalBuffer);e.bufferData(e.ARRAY_BUFFER,pa,W)}if(Ba&&na.hasTangents){e.bindBuffer(e.ARRAY_BUFFER,H.__webGLTangentBuffer);e.bufferData(e.ARRAY_BUFFER,ba,W)}if(va&&O>0){e.bindBuffer(e.ARRAY_BUFFER,H.__webGLUVBuffer);e.bufferData(e.ARRAY_BUFFER,wa,W)}if(va&&ca>0){e.bindBuffer(e.ARRAY_BUFFER,H.__webGLUV2Buffer);e.bufferData(e.ARRAY_BUFFER,xa,W)}if(za){e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,H.__webGLFaceBuffer);e.bufferData(e.ELEMENT_ARRAY_BUFFER,
sa,W);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,H.__webGLLineBuffer);e.bufferData(e.ELEMENT_ARRAY_BUFFER,la,W)}}m(objlist,K,n,h,o,u)}p.__dirtyVertices=false;p.__dirtyElements=false;p.__dirtyUvs=false;p.__dirtyNormals=false;p.__dirtyTangents=false;p.__dirtyColors=false}else if(o instanceof Line){if(!p.__webGLVertexBuffer){p.__webGLVertexBuffer=e.createBuffer();p.__webGLColorBuffer=e.createBuffer();n=p.vts.length;p.__vertexArray=new Float32Array(n*3);p.__colorArray=new Float32Array(n*3);p.__webGLLineCount=
n;p.__dirtyVertices=true;p.__dirtyColors=true}if(p.__dirtyVertices||p.__dirtyColors){n=e.DYNAMIC_DRAW;C=p.vts;H=p.colors;O=C.length;W=H.length;ca=p.__vertexArray;aa=p.__colorArray;$=p.__dirtyColors;if(p.__dirtyVertices){for(G=0;G<O;G++){z=C[G].ppos;h=G*3;ca[h]=z.x;ca[h+1]=z.y;ca[h+2]=z.z}e.bindBuffer(e.ARRAY_BUFFER,p.__webGLVertexBuffer);e.bufferData(e.ARRAY_BUFFER,ca,n)}if($){for(G=0;G<W;G++){color=H[G];h=G*3;aa[h]=color.r;aa[h+1]=color.g;aa[h+2]=color.b}e.bindBuffer(e.ARRAY_BUFFER,p.__webGLColorBuffer);
e.bufferData(e.ARRAY_BUFFER,aa,n)}}m(objlist,K,0,p,o,u);p.__dirtyVertices=false;p.__dirtyColors=false}else if(o instanceof ParticleSystem){if(!p.__webGLVertexBuffer){p.__webGLVertexBuffer=e.createBuffer();p.__webGLColorBuffer=e.createBuffer();n=p.vts.length;p.__vertexArray=new Float32Array(n*3);p.__colorArray=new Float32Array(n*3);p.__sortArray=[];p.__webGLParticleCount=n;p.__dirtyVertices=true;p.__dirtyColors=true}if(p.__dirtyVertices||p.__dirtyColors||o.sortParticles)b(p,e.DYNAMIC_DRAW,
o,CC);m(objlist,K,0,p,o,u);p.__dirtyVertices=false;p.__dirtyColors=false}else if(o instanceof MarchingCubes)if(K[0]==undefined){h.__webGLoBsImmediate.push({object:o,opaque:{list:[],count:0},transparent:{list:[],count:0},root:u});K[0]=1}}function m(h,o,u,n,p,K){if(o[u]==undefined){h.push({buffer:n,object:p,opaque:{list:[],count:0},transparent:{list:[],count:0},root:K});o[u]=1}}function y(h,o){h._modelViewMatrix.multiplyToArray(o.matrix,h.matrixWorld,h._modelViewMatrixArray);h._normalMatrix=
m4.makeInvert3x3(h._modelViewMatrix).transposeIntoArray(h._normalMatrixArray)}function B(h){if(h!=T){switch(h){case AdditiveBlending:e.blendEquation(e.FUNC_ADD);e.blendFunc(e.ONE,e.ONE);break;case SubtractiveBlending:e.blendFunc(e.DST_COLOR,e.ZERO);break;case BillboardBlending:e.blendEquation(e.FUNC_ADD);e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);break;default:e.blendEquation(e.FUNC_ADD);e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA)}T=h}}function A(h,o){if(h&&!h.__webGLFramebuffer){h.__webGLFramebuffer=
e.CrFramebuffer();h.__webGLRenderbuffer=e.CrRenderbuffer();h.__webGLTexture=e.createTexture();e.bindRenderbuffer(e.RENDERBUFFER,h.__webGLRenderbuffer);e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,h.width,h.height);e.bindTexture(e.TEXTURE_2D,h.__webGLTexture);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,I(h.wrap_s));e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,I(h.wrap_t));e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,I(h.mag_filter));e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,
I(h.min_filter));e.texImage2D(e.TEXTURE_2D,0,I(h.format),h.width,h.height,0,I(h.format),I(h.type),null);e.bindFramebuffer(e.FRAMEBUFFER,h.__webGLFramebuffer);e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,h.__webGLTexture,0);e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,h.__webGLRenderbuffer);e.bindTexture(e.TEXTURE_2D,null);e.bindRenderbuffer(e.RENDERBUFFER,null);e.bindFramebuffer(e.FRAMEBUFFER,null)}var u,n,p;if(h){u=h.__webGLFramebuffer;n=h.width;
p=h.height}else{u=null;n=D.width;p=D.height}if(u!=U){e.bindFramebuffer(e.FRAMEBUFFER,u);e.viewport(0,0,n,p);o&&e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);U=u}}function t(h,o){var u;if(h=="fragment")u=e.createShader(e.FRAGMENT_SHADER);else if(h=="vertex")u=e.createShader(e.VERTEX_SHADER);e.shaderSource(u,o);e.compileShader(u);if(!e.getShaderParameter(u,e.COMPILE_STATUS)){alert(e.getShaderInfoLog(u));return null}return u}function I(h){switch(h){case RepeatWrapping:return e.REPEAT;case ClampToEdgeWrapping:return e.CLAMP_TO_EDGE;
case MirroredRepeatWrapping:return e.MIRRORED_REPEAT;case NearestFilter:return e.NEAREST;case NearestMipMapNearestFilter:return e.NEAREST_MIPMAP_NEAREST;case NearestMipMapLinearFilter:return e.NEAREST_MIPMAP_LINEAR;case LinearFilter:return e.LINEAR;case LinearMipMapNearestFilter:return e.LINEAR_MIPMAP_NEAREST;case LinearMipMapLinearFilter:return e.LINEAR_MIPMAP_LINEAR;case ByteType:return e.BYTE;case UnsignedByteType:return e.UNSIGNED_BYTE;case ShortType:return e.SHORT;
case UnsignedShortType:return e.UNSIGNED_SHORT;case IntType:return e.INT;case UnsignedShortType:return e.UNSIGNED_INT;case FloatType:return e.FLOAT;case AlphaFormat:return e.ALPHA;case RGBFormat:return e.RGB;case RGBAFormat:return e.RGBA;case LuminanceFormat:return e.LUMINANCE;case LuminanceAlphaFormat:return e.LUMINANCE_ALPHA}return 0}var D=document.createElement("canvas"),e,P=null,U=null,F=null,L=null,T=null,N=[new Vector4,new Vector4,
new Vector4,new Vector4,new Vector4,new Vector4],S=new m4,R=new Float32Array(16),J=new Float32Array(16),E=new Vector4,Y=true,M=new Color(0),X=0;if(a){if(a.antialias!==undefined)Y=a.antialias;a.clearColor!==undefined&&M.setHex(a.clearColor);if(a.clearAlpha!==undefined)X=a.clearAlpha}this.domElement=D;this.autoClear=true;(function(h,o,u){try{e=D.getContext("experimental-webgl",{antialias:h})}catch(n){console.log(n)}if(!e){alert("WebGL not supported");throw"cannot Cr webgl context";
}e.clearColor(0,0,0,1);e.clearDepth(1);e.enable(e.DEPTH_TEST);e.depthFunc(e.LEQUAL);e.frontFace(e.CCW);e.cullFace(e.BACK);e.enable(e.CULL_FACE);e.enable(e.BLEND);e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA);e.clearColor(o.r,o.g,o.b,u);_cullEnabled=true})(Y,M,X);this.context=e;this.lights={ambient:[0,0,0],directional:{length:0,colors:[],pposs:[]},point:{length:0,colors:[],pposs:[]}};this.setSize=function(h,o){D.width=h;D.height=o;e.viewport(0,0,D.width,D.height)};this.setClearColorHex=function(h,
o){var u=new Color(h);e.clearColor(u.r,u.g,u.b,o)};this.setClearColor=function(h,o){e.clearColor(h.r,h.g,h.b,o)};this.clear=function(){e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)};this.setupLights=function(h,o){var u,n,p,K=0,H=0,C=0,G,z,O,W=this.lights,aa=W.directional.colors,ca=W.directional.pposs,$=W.point.colors,Z=W.point.pposs,V=0,ma=0;u=0;for(n=o.length;u<n;u++){p=o[u];G=p.color;z=p.ppos;O=p.intensity;if(p instanceof AmbientLight){K+=G.r;H+=G.g;C+=G.b}else if(p instanceof
DirectionalLight){p=V*3;aa[p]=G.r*O;aa[p+1]=G.g*O;aa[p+2]=G.b*O;ca[p]=z.x;ca[p+1]=z.y;ca[p+2]=z.z;V+=1}else if(p instanceof PointLight){p=ma*3;$[p]=G.r*O;$[p+1]=G.g*O;$[p+2]=G.b*O;Z[p]=z.x;Z[p+1]=z.y;Z[p+2]=z.z;ma+=1}}for(u=V*3;u<aa.length;u++)aa[u]=0;for(u=ma*3;u<$.length;u++)$[u]=0;W.point.length=ma;W.directional.length=V;W.ambient[0]=K;W.ambient[1]=H;W.ambient[2]=C};this.initMt=function(h,o,u){var n,p;if(h instanceof MeshDepthMt)c(h,ShaderLib.depth);else if(h instanceof
MeshNormalMt)c(h,ShaderLib.normal);else if(h instanceof mBm)c(h,ShaderLib.basic);else if(h instanceof mLm)c(h,ShaderLib.lambert);else if(h instanceof mQm)c(h,ShaderLib.phong);else if(h instanceof LineBasicMt)c(h,ShaderLib.basic);else h instanceof ParticleBasicMt&&c(h,ShaderLib.particle_basic);var K,H,C,G;p=C=G=0;for(K=o.length;p<K;p++){H=o[p];H instanceof DirectionalLight&&
C++;H instanceof PointLight&&G++}if(G+C<=4)o=C;else{o=Math.ceil(4*C/(G+C));G=4-o}p={directional:o,point:G};G=h.fragment_shader;o=h.vertex_shader;K={fog:u,map:h.map,env_map:h.env_map,light_map:h.light_map,vertex_colors:h.vertex_colors,maxDirLights:p.directional,maxPointLights:p.point};u=e.createProgram();p=["#ifdef GL_ES\nprecision highp float;\n#endif","#define MAX_DIR_LIGHTS "+K.maxDirLights,"#define MAX_POINT_LIGHTS "+K.maxPointLights,K.fog?"#define USE_FOG":"",K.fog instanceof FogExp2?
"#define FOG_EXP2":"",K.map?"#define USE_MAP":"",K.env_map?"#define USE_ENVMAP":"",K.light_map?"#define USE_LIGHTMAP":"",K.vertex_colors?"#define USE_COLOR":"","uniform mat4 viewMatrix;\nuniform vec3 CCPosition;\n"].join("\n");K=[e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0?"#define VERTEX_TEXTURES":"","#define MAX_DIR_LIGHTS "+K.maxDirLights,"#define MAX_POINT_LIGHTS "+K.maxPointLights,K.map?"#define USE_MAP":"",K.env_map?"#define USE_ENVMAP":"",K.light_map?"#define USE_LIGHTMAP":"",K.vertex_colors?
"#define USE_COLOR":"","uniform mat4 objectMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 pM;\nuniform mat4 viewMatrix;\nuniform mat3 normalMatrix;\nuniform vec3 CCPosition;\nattribute vec3 ppos;\nattribute vec3 normal;\nattribute vec3 color;\nattribute vec2 uv;\nattribute vec2 uv2;\n"].join("\n");e.attachShader(u,t("fragment",p+G));e.attachShader(u,t("vertex",K+o));e.linkProgram(u);e.getProgramParameter(u,e.LINK_STATUS)||alert("Could not initialise shaders\nVALIDATE_STATUS: "+
e.getProgramParameter(u,e.VALIDATE_STATUS)+", gl error ["+e.getError()+"]");u.uniforms={};u.attributes={};h.program=u;u=["viewMatrix","modelViewMatrix","pM","normalMatrix","objectMatrix","CCPosition"];for(n in h.uniforms)u.push(n);n=h.program;G=0;for(o=u.length;G<o;G++){p=u[G];n.uniforms[p]=e.getUniformLocation(n,p)}h=h.program;n=["ppos","normal","uv","uv2","tangent","color"];u=0;for(G=n.length;u<G;u++){o=n[u];h.attributes[o]=e.getAttribLocation(h,o)}};this.setProgram=function(h,
o,u,n,p){n.program||this.initMt(n,o,u);var K=n.program,H=K.uniforms,C=n.uniforms;if(K!=P){e.useProgram(K);P=K;e.uniformMatrix4fv(H.pM,false,R)}if(u&&(n instanceof mBm||n instanceof mLm||n instanceof mQm||n instanceof LineBasicMt||n instanceof ParticleBasicMt)){C.fogColor.value.setHex(u.color.hex);if(u instanceof Fog){C.fogNear.value=u.near;C.fogFar.value=u.far}else if(u instanceof FogExp2)C.fogDensity.value=
u.density}if(n instanceof mQm||n instanceof mLm){this.setupLights(K,o);o=this.lights;C.enableLighting.value=o.directional.length+o.point.length;C.ambientLightColor.value=o.ambient;C.directionalLightColor.value=o.directional.colors;C.directionalLightDirection.value=o.directional.pposs;C.pointLightColor.value=o.point.colors;C.pointLightPosition.value=o.point.pposs}if(n instanceof mBm||n instanceof mLm||n instanceof
mQm){C.diffuse.value.setRGB(n.color.r*n.op,n.color.g*n.op,n.color.b*n.op);C.op.value=n.op;C.map.texture=n.map;C.light_map.texture=n.light_map;C.env_map.texture=n.env_map;C.rfl.value=n.rfl;C.refraction_ratio.value=n.refraction_ratio;C.combine.value=n.combine;C.useRefract.value=n.env_map&&n.env_map.mapping instanceof CubeRefractionMapping}if(n instanceof LineBasicMt){C.diffuse.value.setRGB(n.color.r*n.op,n.color.g*
n.op,n.color.b*n.op);C.op.value=n.op}else if(n instanceof ParticleBasicMt){C.psColor.value.setRGB(n.color.r*n.op,n.color.g*n.op,n.color.b*n.op);C.op.value=n.op;C.size.value=n.size;C.map.texture=n.map}else if(n instanceof mQm){C.ambient.value.setRGB(n.ambient.r,n.ambient.g,n.ambient.b);C.specular.value.setRGB(n.specular.r,n.specular.g,n.specular.b);C.shininess.value=n.shininess}else if(n instanceof MeshDepthMt){C.mNear.value=
h.near;C.mFar.value=h.far;C.op.value=n.op}else if(n instanceof MeshNormalMt)C.op.value=n.op;var G,z,O;for(G in C)if(O=K.uniforms[G]){u=C[G];z=u.type;o=u.value;if(z=="i")e.uniform1i(O,o);else if(z=="f")e.uniform1f(O,o);else if(z=="fv1")e.uniform1fv(O,o);else if(z=="fv")e.uniform3fv(O,o);else if(z=="v2")e.uniform2f(O,o.x,o.y);else if(z=="v3")e.uniform3f(O,o.x,o.y,o.z);else if(z=="c")e.uniform3f(O,o.r,o.g,o.b);else if(z=="t"){e.uniform1i(O,o);if(u=u.texture)if(u.image instanceof
Array&&u.image.length==6){if(u.image.length==6){if(!u.image.__webGLTextureCube&&!u.image.__cubeMapInitialized&&u.image.loadCount==6){u.image.__webGLTextureCube=e.createTexture();e.bindTexture(e.TEXTURE_CUBE_MAP,u.image.__webGLTextureCube);e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE);e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_LINEAR);
for(z=0;z<6;++z)e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+z,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,u.image[z]);e.generateMipmap(e.TEXTURE_CUBE_MAP);e.bindTexture(e.TEXTURE_CUBE_MAP,null);u.image.__cubeMapInitialized=true}e.activeTexture(e.TEXTURE0+o);e.bindTexture(e.TEXTURE_CUBE_MAP,u.image.__webGLTextureCube)}}else{if(!u.__webGLTexture&&u.image.loaded){u.__webGLTexture=e.createTexture();e.bindTexture(e.TEXTURE_2D,u.__webGLTexture);e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,u.image);e.texParameteri(e.TEXTURE_2D,
e.TEXTURE_WRAP_S,I(u.wrap_s));e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,I(u.wrap_t));e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,I(u.mag_filter));e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,I(u.min_filter));e.generateMipmap(e.TEXTURE_2D);e.bindTexture(e.TEXTURE_2D,null)}e.activeTexture(e.TEXTURE0+o);e.bindTexture(e.TEXTURE_2D,u.__webGLTexture)}}}e.uniformMatrix4fv(H.modelViewMatrix,false,p._modelViewMatrixArray);e.uniformMatrix3fv(H.normalMatrix,false,p._normalMatrixArray);if(n instanceof
MeshShaderMt||n instanceof mQm||n.env_map)e.uniform3f(H.CCPosition,h.ppos.x,h.ppos.y,h.ppos.z);if(n instanceof MeshShaderMt||n.env_map)e.uniformMatrix4fv(H.objectMatrix,false,p._objectMatrixArray);if(n instanceof mQm||n instanceof mLm||n instanceof MeshShaderMt)e.uniformMatrix4fv(H.viewMatrix,false,J);return K};this.renderBuffer=function(h,o,u,n,p,K){h=this.setProgram(h,o,u,n,K).attributes;
e.bindBuffer(e.ARRAY_BUFFER,p.__webGLVertexBuffer);e.vertexAttribPointer(h.ppos,3,e.FLOAT,false,0,0);e.enableVertexAttribArray(h.ppos);if(h.color>=0){e.bindBuffer(e.ARRAY_BUFFER,p.__webGLColorBuffer);e.vertexAttribPointer(h.color,3,e.FLOAT,false,0,0);e.enableVertexAttribArray(h.color)}if(h.normal>=0){e.bindBuffer(e.ARRAY_BUFFER,p.__webGLNormalBuffer);e.vertexAttribPointer(h.normal,3,e.FLOAT,false,0,0);e.enableVertexAttribArray(h.normal)}if(h.tangent>=0){e.bindBuffer(e.ARRAY_BUFFER,p.__webGLTangentBuffer);
e.vertexAttribPointer(h.tangent,4,e.FLOAT,false,0,0);e.enableVertexAttribArray(h.tangent)}if(h.uv>=0)if(p.__webGLUVBuffer){e.bindBuffer(e.ARRAY_BUFFER,p.__webGLUVBuffer);e.vertexAttribPointer(h.uv,2,e.FLOAT,false,0,0);e.enableVertexAttribArray(h.uv)}else e.disableVertexAttribArray(h.uv);if(h.uv2>=0)if(p.__webGLUV2Buffer){e.bindBuffer(e.ARRAY_BUFFER,p.__webGLUV2Buffer);e.vertexAttribPointer(h.uv2,2,e.FLOAT,false,0,0);e.enableVertexAttribArray(h.uv2)}else e.disableVertexAttribArray(h.uv2);if(K instanceof
Mesh)if(n.wf){e.lineWidth(n.wf_lw);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,p.__webGLLineBuffer);e.drawElements(e.LINES,p.__webGLLineCount,e.UNSIGNED_SHORT,0)}else{e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,p.__webGLFaceBuffer);e.drawElements(e.TRIANGLES,p.__webGLFaceCount,e.UNSIGNED_SHORT,0)}else if(K instanceof Line){K=K.type==LineStrip?e.LINE_STRIP:e.LINES;e.lineWidth(n.lw);e.drawArrays(K,0,p.__webGLLineCount)}else K instanceof ParticleSystem&&e.drawArrays(e.POINTS,
0,p.__webGLParticleCount)};this.render=function(h,o,u,n){var p,K,H,C,G,z,O,W=h.lights,aa=h.fog;o.aum&&o.um();o.matrix.flattenToArray(J);o.pM.flattenToArray(R);S.multiply(o.pM,o.matrix);g(S);this.initWebGLoBs(h,o);A(u,n!==undefined?n:true);this.autoClear&&this.clear();C=h.__webGLoBs.length;for(n=0;n<C;n++){p=h.__webGLoBs[n];z=p.object;if(z.vs){if(p.root){z.aum&&z.um();z.matrixWorld.cy(z.matrix);w(z)}if(!(z instanceof
Mesh)||j(z)){z.matrixWorld.flattenToArray(z._objectMatrixArray);y(z,o);q(p);p.render=true}else p.render=false}else p.render=false}G=h.__webGLoBsImmediate.length;for(n=0;n<G;n++){p=h.__webGLoBsImmediate[n];z=p.object;if(z.vs){if(z.aum){z.um();z.matrixWorld.cy(z.matrix);z.matrixWorld.flattenToArray(z._objectMatrixArray)}y(z,o);k(p)}}B(NormalBlending);for(n=0;n<C;n++){p=h.__webGLoBs[n];if(p.render){z=p.object;O=p.buffer;H=p.opaque;f(z);for(p=0;p<
H.count;p++){material=H.list[p];this.setDepthTest(material.depth_test);this.renderBuffer(o,W,aa,material,O,z)}}}for(n=0;n<G;n++){p=h.__webGLoBsImmediate[n];z=p.object;if(z.vs){H=p.opaque;f(z);for(p=0;p<H.count;p++){material=H.list[p];this.setDepthTest(material.depth_test);K=this.setProgram(o,W,aa,material,z);z.render(function(ca){d(ca,K)})}}}for(n=0;n<C;n++){p=h.__webGLoBs[n];if(p.render){z=p.object;O=p.buffer;H=p.transparent;f(z);for(p=0;p<H.count;p++){material=H.list[p];B(material.blending);
this.setDepthTest(material.depth_test);this.renderBuffer(o,W,aa,material,O,z)}}}for(n=0;n<G;n++){p=h.__webGLoBsImmediate[n];z=p.object;if(z.vs){H=p.transparent;f(z);for(p=0;p<H.count;p++){material=H.list[p];B(material.blending);this.setDepthTest(material.depth_test);K=this.setProgram(o,W,aa,material,z);z.render(function(ca){d(ca,K)})}}}if(u&&u.min_filter!==NearestFilter&&u.min_filter!==LinearFilter){e.bindTexture(e.TEXTURE_2D,u.__webGLTexture);e.generateMipmap(e.TEXTURE_2D);e.bindTexture(e.TEXTURE_2D,
null)}};this.initWebGLoBs=function(h){var o,u,n;if(!h.__webGLoBs){h.__webGLoBs=[];h.__webGLoBsMap={};h.__webGLoBsImmediate=[]}o=0;for(u=h.objects.length;o<u;o++){n=h.objects[o];x(h,n,true);v(h,n)}};this.removeoB=function(h,o){var u,n;for(u=h.__webGLoBs.length-1;u>=0;u--){n=h.__webGLoBs[u].object;o==n&&h.__webGLoBs.splice(u,1)}};this.setDepthTest=function(h){h?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST)};this.setFaceCulling=function(h,o){if(h){!o||o=="ccw"?e.frontFace(e.CCW):
e.frontFace(e.CW);if(h=="back")e.cullFace(e.BACK);else h=="front"?e.cullFace(e.FRONT):e.cullFace(e.FRONT_AND_BACK);e.enable(e.CULL_FACE)}else e.disable(e.CULL_FACE)};this.supportsVertexTextures=function(){return e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0}};
Sn={fog_pars_fragment:"#ifdef USE_FOG\nuniform vec3 fogColor;\n#ifdef FOG_EXP2\nuniform float fogDensity;\n#else\nuniform float fogNear;\nuniform float fogFar;\n#endif\n#endif",fog_fragment:"#ifdef USE_FOG\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n#ifdef FOG_EXP2\nconst float LOG2 = 1.442695;\nfloat fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );\nfogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );\n#else\nfloat fogFactor = smoothstep( fogNear, fogFar, depth );\n#endif\ngl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );\n#endif",envmap_pars_fragment:"#ifdef USE_ENVMAP\nvarying vec3 vReflect;\nuniform float rfl;\nuniform samplerCube env_map;\nuniform int combine;\n#endif",
envmap_fragment:"#ifdef USE_ENVMAP\nvec4 cubeColor = textureCube( env_map, vec3( -vReflect.x, vReflect.yz ) );\nif ( combine == 1 ) {\ngl_FragColor = vec4( mix( gl_FragColor.xyz, cubeColor.xyz, rfl ), op );\n} else {\ngl_FragColor = gl_FragColor * cubeColor;\n}\n#endif",envmap_pars_vertex:"#ifdef USE_ENVMAP\nvarying vec3 vReflect;\nuniform float refraction_ratio;\nuniform bool useRefract;\n#endif",envmap_vertex:"#ifdef USE_ENVMAP\nvec4 mPosition = objectMatrix * vec4( ppos, 1.0 );\nvec3 nWorld = mat3( objectMatrix[0].xyz, objectMatrix[1].xyz, objectMatrix[2].xyz ) * normal;\nif ( useRefract ) {\nvReflect = refract( normalize( mPosition.xyz - CCPosition ), normalize( nWorld.xyz ), refraction_ratio );\n} else {\nvReflect = reflect( normalize( mPosition.xyz - CCPosition ), normalize( nWorld.xyz ) );\n}\n#endif",
map_particle_pars_fragment:"#ifdef USE_MAP\nuniform sampler2D map;\n#endif",map_particle_fragment:"#ifdef USE_MAP\ngl_FragColor = gl_FragColor * texture2D( map, gl_PointCoord );\n#endif",map_pars_fragment:"#ifdef USE_MAP\nvarying vec2 vUv;\nuniform sampler2D map;\n#endif",map_pars_vertex:"#ifdef USE_MAP\nvarying vec2 vUv;\n#endif",map_fragment:"#ifdef USE_MAP\ngl_FragColor = gl_FragColor * texture2D( map, vUv );\n#endif",map_vertex:"#ifdef USE_MAP\nvUv = uv;\n#endif",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\nvarying vec2 vUv2;\nuniform sampler2D light_map;\n#endif",
lightmap_pars_vertex:"#ifdef USE_LIGHTMAP\nvarying vec2 vUv2;\n#endif",lightmap_fragment:"#ifdef USE_LIGHTMAP\ngl_FragColor = gl_FragColor * texture2D( light_map, vUv2 );\n#endif",lightmap_vertex:"#ifdef USE_LIGHTMAP\nvUv2 = uv2;\n#endif",lights_pars_vertex:"uniform bool enableLighting;\nuniform vec3 ambientLightColor;\n#if MAX_DIR_LIGHTS > 0\nuniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];\nuniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];\n#endif\n#if MAX_POINT_LIGHTS > 0\nuniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];\nuniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];\n#ifdef PHONG\nvarying vec3 vPointLightVector[ MAX_POINT_LIGHTS ];\n#endif\n#endif",
lights_vertex:"if ( !enableLighting ) {\nvLightWeighting = vec3( 1.0 );\n} else {\nvLightWeighting = ambientLightColor;\n#if MAX_DIR_LIGHTS > 0\nfor( int i = 0; i < MAX_DIR_LIGHTS; i++ ) {\nvec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );\nfloat directionalLightWeighting = max( dot( transformedNormal, normalize( lDirection.xyz ) ), 0.0 );\nvLightWeighting += directionalLightColor[ i ] * directionalLightWeighting;\n}\n#endif\n#if MAX_POINT_LIGHTS > 0\nfor( int i = 0; i < MAX_POINT_LIGHTS; i++ ) {\nvec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );\nvec3 pointLightVector = normalize( lPosition.xyz - mvPosition.xyz );\nfloat pointLightWeighting = max( dot( transformedNormal, pointLightVector ), 0.0 );\nvLightWeighting += pointLightColor[ i ] * pointLightWeighting;\n#ifdef PHONG\nvPointLightVector[ i ] = pointLightVector;\n#endif\n}\n#endif\n}",
lights_pars_fragment:"#if MAX_DIR_LIGHTS > 0\nuniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];\n#endif\n#if MAX_POINT_LIGHTS > 0\nvarying vec3 vPointLightVector[ MAX_POINT_LIGHTS ];\n#endif\nvarying vec3 vViewPosition;\nvarying vec3 vNormal;",lights_fragment:"vec3 normal = normalize( vNormal );\nvec3 viewPosition = normalize( vViewPosition );\nvec4 mColor = vec4( diffuse, op );\nvec4 mSpecular = vec4( specular, op );\n#if MAX_POINT_LIGHTS > 0\nvec4 pointDiffuse  = vec4( 0.0 );\nvec4 pointSpecular = vec4( 0.0 );\nfor( int i = 0; i < MAX_POINT_LIGHTS; i++ ) {\nvec3 pointVector = normalize( vPointLightVector[ i ] );\nvec3 pointHalfVector = normalize( vPointLightVector[ i ] + vViewPosition );\nfloat pointDotNormalHalf = dot( normal, pointHalfVector );\nfloat pointDiffuseWeight = max( dot( normal, pointVector ), 0.0 );\nfloat pointSpecularWeight = 0.0;\nif ( pointDotNormalHalf >= 0.0 )\npointSpecularWeight = pow( pointDotNormalHalf, shininess );\npointDiffuse  += mColor * pointDiffuseWeight;\npointSpecular += mSpecular * pointSpecularWeight;\n}\n#endif\n#if MAX_DIR_LIGHTS > 0\nvec4 dirDiffuse  = vec4( 0.0 );\nvec4 dirSpecular = vec4( 0.0 );\nfor( int i = 0; i < MAX_DIR_LIGHTS; i++ ) {\nvec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );\nvec3 dirVector = normalize( lDirection.xyz );\nvec3 dirHalfVector = normalize( lDirection.xyz + vViewPosition );\nfloat dirDotNormalHalf = dot( normal, dirHalfVector );\nfloat dirDiffuseWeight = max( dot( normal, dirVector ), 0.0 );\nfloat dirSpecularWeight = 0.0;\nif ( dirDotNormalHalf >= 0.0 )\ndirSpecularWeight = pow( dirDotNormalHalf, shininess );\ndirDiffuse  += mColor * dirDiffuseWeight;\ndirSpecular += mSpecular * dirSpecularWeight;\n}\n#endif\nvec4 totalLight = vec4( ambient, op );\n#if MAX_DIR_LIGHTS > 0\ntotalLight += dirDiffuse + dirSpecular;\n#endif\n#if MAX_POINT_LIGHTS > 0\ntotalLight += pointDiffuse + pointSpecular;\n#endif\ngl_FragColor = gl_FragColor * totalLight;",
color_pars_fragment:"#ifdef USE_COLOR\nvarying vec3 vColor;\n#endif",color_fragment:"#ifdef USE_COLOR\ngl_FragColor = gl_FragColor * vec4( vColor, op );\n#endif",color_pars_vertex:"#ifdef USE_COLOR\nvarying vec3 vColor;\n#endif",color_vertex:"#ifdef USE_COLOR\nvColor = color;\n#endif"};
UniformsLib={common:{diffuse:{type:"c",value:new Color(15658734)},op:{type:"f",value:1},map:{type:"t",value:0,texture:null},light_map:{type:"t",value:2,texture:null},env_map:{type:"t",value:1,texture:null},useRefract:{type:"i",value:0},rfl:{type:"f",value:1},refraction_ratio:{type:"f",value:0.98},combine:{type:"i",value:0},fogDensity:{type:"f",value:2.5E-4},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2E3},fogColor:{type:"c",value:new Color(16777215)}},lights:{enableLighting:{type:"i",
value:1},ambientLightColor:{type:"fv",value:[]},directionalLightDirection:{type:"fv",value:[]},directionalLightColor:{type:"fv",value:[]},pointLightPosition:{type:"fv",value:[]},pointLightColor:{type:"fv",value:[]}},particle:{psColor:{type:"c",value:new Color(15658734)},op:{type:"f",value:1},size:{type:"f",value:1},map:{type:"t",value:0,texture:null},fogDensity:{type:"f",value:2.5E-4},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2E3},fogColor:{type:"c",value:new Color(16777215)}}};
ShaderLib={depth:{uniforms:{mNear:{type:"f",value:1},mFar:{type:"f",value:2E3},op:{type:"f",value:1}},fragment_shader:"uniform float mNear;\nuniform float mFar;\nuniform float op;\nvoid main() {\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\nfloat color = 1.0 - smoothstep( mNear, mFar, depth );\ngl_FragColor = vec4( vec3( color ), op );\n}",vertex_shader:"void main() {\ngl_Position = pM * modelViewMatrix * vec4( ppos, 1.0 );\n}"},normal:{uniforms:{op:{type:"f",
value:1}},fragment_shader:"uniform float op;\nvarying vec3 vNormal;\nvoid main() {\ngl_FragColor = vec4( 0.5 * normalize( vNormal ) + 0.5, op );\n}",vertex_shader:"varying vec3 vNormal;\nvoid main() {\nvec4 mvPosition = modelViewMatrix * vec4( ppos, 1.0 );\nvNormal = normalize( normalMatrix * normal );\ngl_Position = pM * mvPosition;\n}"},basic:{uniforms:UniformsLib.common,fragment_shader:["uniform vec3 diffuse;\nuniform float op;",Sn.color_pars_fragment,
Sn.map_pars_fragment,Sn.lightmap_pars_fragment,Sn.envmap_pars_fragment,Sn.fog_pars_fragment,"void main() {\ngl_FragColor = vec4( diffuse, op );",Sn.map_fragment,Sn.lightmap_fragment,Sn.color_fragment,Sn.envmap_fragment,Sn.fog_fragment,"}"].join("\n"),vertex_shader:[Sn.map_pars_vertex,Sn.lightmap_pars_vertex,Sn.envmap_pars_vertex,Sn.color_pars_vertex,
"void main() {\nvec4 mvPosition = modelViewMatrix * vec4( ppos, 1.0 );",Sn.map_vertex,Sn.lightmap_vertex,Sn.envmap_vertex,Sn.color_vertex,"gl_Position = pM * mvPosition;\n}"].join("\n")},lambert:{uniforms:Uniforms.merge([UniformsLib.common,UniformsLib.lights]),fragment_shader:["uniform vec3 diffuse;\nuniform float op;\nvarying vec3 vLightWeighting;",Sn.color_pars_fragment,Sn.map_pars_fragment,
Sn.lightmap_pars_fragment,Sn.envmap_pars_fragment,Sn.fog_pars_fragment,"void main() {\ngl_FragColor = vec4( diffuse, op );\ngl_FragColor = gl_FragColor * vec4( vLightWeighting, 1.0 );",Sn.map_fragment,Sn.lightmap_fragment,Sn.color_fragment,Sn.envmap_fragment,Sn.fog_fragment,"}"].join("\n"),vertex_shader:["varying vec3 vLightWeighting;",Sn.map_pars_vertex,Sn.lightmap_pars_vertex,
Sn.envmap_pars_vertex,Sn.lights_pars_vertex,Sn.color_pars_vertex,"void main() {\nvec4 mvPosition = modelViewMatrix * vec4( ppos, 1.0 );",Sn.map_vertex,Sn.lightmap_vertex,Sn.envmap_vertex,Sn.color_vertex,"vec3 transformedNormal = normalize( normalMatrix * normal );",Sn.lights_vertex,"gl_Position = pM * mvPosition;\n}"].join("\n")},phong:{uniforms:Uniforms.merge([UniformsLib.common,
UniformsLib.lights,{ambient:{type:"c",value:new Color(328965)},specular:{type:"c",value:new Color(1118481)},shininess:{type:"f",value:30}}]),fragment_shader:["uniform vec3 diffuse;\nuniform float op;\nuniform vec3 ambient;\nuniform vec3 specular;\nuniform float shininess;\nvarying vec3 vLightWeighting;",Sn.color_pars_fragment,Sn.map_pars_fragment,Sn.lightmap_pars_fragment,Sn.envmap_pars_fragment,Sn.fog_pars_fragment,
Sn.lights_pars_fragment,"void main() {\ngl_FragColor = vec4( vLightWeighting, 1.0 );",Sn.lights_fragment,Sn.map_fragment,Sn.lightmap_fragment,Sn.color_fragment,Sn.envmap_fragment,Sn.fog_fragment,"}"].join("\n"),vertex_shader:["#define PHONG\nvarying vec3 vLightWeighting;\nvarying vec3 vViewPosition;\nvarying vec3 vNormal;",Sn.map_pars_vertex,Sn.lightmap_pars_vertex,Sn.envmap_pars_vertex,
Sn.lights_pars_vertex,Sn.color_pars_vertex,"void main() {\nvec4 mvPosition = modelViewMatrix * vec4( ppos, 1.0 );",Sn.map_vertex,Sn.lightmap_vertex,Sn.envmap_vertex,Sn.color_vertex,"#ifndef USE_ENVMAP\nvec4 mPosition = objectMatrix * vec4( ppos, 1.0 );\n#endif\nvViewPosition = CCPosition - mPosition.xyz;\nvec3 transformedNormal = normalize( normalMatrix * normal );\nvNormal = transformedNormal;",Sn.lights_vertex,
"gl_Position = pM * mvPosition;\n}"].join("\n")},particle_basic:{uniforms:UniformsLib.particle,fragment_shader:["uniform vec3 psColor;\nuniform float op;",Sn.color_pars_fragment,Sn.map_particle_pars_fragment,Sn.fog_pars_fragment,"void main() {\ngl_FragColor = vec4( psColor, op );",Sn.map_particle_fragment,Sn.color_fragment,Sn.fog_fragment,"}"].join("\n"),vertex_shader:["uniform float size;",Sn.color_pars_vertex,
"void main() {",Sn.color_vertex,"vec4 mvPosition = modelViewMatrix * vec4( ppos, 1.0 );\ngl_Position = pM * mvPosition;\ngl_PointSize = size;\n}"].join("\n")}};RenderableoB=function(){this.z=this.object=null};
RenderableFace3=function(){this.z=null;this.v1=new Vertex;this.v2=new Vertex;this.v3=new Vertex;this.centroidWorld=new v3;this.centroidScreen=new v3;this.normalWorld=new v3;this.vnsWorld=[];this.faceMts=this.meshMts=null;this.overdraw=false;this.uvs=[null,null,null]};RenderableParticle=function(){this.rt=this.z=this.y=this.x=null;this.sC=new Vector2;this.mTs=null};
RenderableLine=function(){this.z=null;this.v1=new Vertex;this.v2=new Vertex;this.mTs=null};
Detector={canvas:!!window.CanvasRenderingContext2D,webgl:!!window.WebGLRenderingContext,workers:!!window.Worker,addGetWebGLMessage:function(a){var b=document.body,c="oldie";if(a){if(a.parent!==undefined)b=a.parent;if(a.id!==undefined)c=a.id}a=document.createElement("center");var d=document.createElement("div");d.innerHTML='Sorry, your browser doesn\'t support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a><br/>\n<br/>\nPlease try in\n<a href="http://www.google.com/chrome">Chrome 9+</a> /\n<a href="http://www.mozilla.com/en-US/firefox/all-beta.html">Firefox 4+</a> /\n<a href="http://nightly.webkit.org/">Safari OSX 10.6+</a>';d.id=
c;c=d.style;c.fontFamily="monospace";c.fontSize="13px";c.textAlign="center";c.background="#eee";c.color="#000";c.padding="1em";c.width="475px";c.margin="5em auto 0";a.appendChild(d);b.appendChild(a);return d}};
var GGUtils={merge:function(a,b){var c=b instanceof Mesh,d=a.vts.length,f=c?b.gG:b,g=a.vts,j=f.vts,l=a.faces,k=f.faces,q=a.uvs;f=f.uvs;c&&b.aum&&b.um();for(var w=0,v=j.length;w<v;w++){var x=new Vertex(j[w].ppos.clone());c&&b.matrix.mV3(x.ppos);g.push(x)}w=0;for(v=k.length;w<v;w++){j=k[w];var m,y=j.vns;if(j instanceof Face3)m=new Face3(j.a+d,j.b+d,j.c+d);else if(j instanceof Face4)m=new Face4(j.a+
d,j.b+d,j.c+d,j.d+d);m.centroid.cy(j.centroid);m.normal.cy(j.normal);c=0;for(g=y.length;c<g;c++){x=y[c];m.vns.push(x.clone())}m.mTs=j.mTs.slice();l.push(m)}w=0;for(v=f.length;w<v;w++){d=f[w];l=[];c=0;for(g=d.length;c<g;c++)l.push(new UV(d[c].u,d[c].v));q.push(l)}}},ImageUtils={lT:function(a,b,c){var d=new Image;d.onload=function(){this.loaded=true;c&&c(this)};d.src=a;return new Texture(d,b)},loadArray:function(a,b){var c,d,f=[];c=f.loadCount=0;for(d=
a.length;c<d;++c){f[c]=new Image;f[c].loaded=0;f[c].onload=function(){f.loadCount+=1;this.loaded=true;b&&b(this)};f[c].src=a[c]}return f}},SceneUtils={loadScene:function(a,b,c,d){a=new Worker(a);a.postMessage(0);a.onmessage=function(f){function g(){for(w in F.objects)if(!J.objects[w]){B=F.objects[w];if(D=J.geometries[B.gG]){U=[];for(i=0;i<B.mTs.length;i++)U[i]=J.mTs[B.mTs[i]];A=B.ppos;r=B.rt;s=B.sC;object=new Mesh(D,U);object.ppos.set(A[0],A[1],A[2]);
object.rt.set(r[0],r[1],r[2]);object.sC.set(s[0],s[1],s[2]);object.vs=B.vs;J.scene.addoB(object);J.objects[w]=object}}}function j(E){return function(Y){J.geometries[E]=Y;g();T-=1;l()}}function l(){d({total_models:S,total_textures:R,loaded_models:S-T,loaded_textures:R-N},J);T==0&&N==0&&c(J)}var k,q,w,v,x,m,y,B,A,t,I,D,e,P,U,F,L,T,N,S,R,J;F=f.data;L=new Loader;N=T=0;J={scene:new Scene,geometries:{},mTs:{},textures:{},objects:{},CCs:{},lights:{},fogs:{}};
f=function(){N-=1;l()};for(x in F.CCs){t=F.CCs[x];if(t.type=="perspective")e=new Camera(t.fov,t.aspect,t.near,t.far);else if(t.type=="ortho"){e=new Camera;e.pM=m4.makeOrtho(t.left,t.right,t.top,t.bottom,t.near,t.far)}A=t.ppos;t=t.target;e.ppos.set(A[0],A[1],A[2]);e.target.ppos.set(t[0],t[1],t[2]);J.CCs[x]=e}for(v in F.lights){x=F.lights[v];if(x.type=="directional"){A=x.direction;light=new DirectionalLight;light.ppos.set(A[0],A[1],
A[2]);light.ppos.normalize()}else if(x.type=="point"){A=x.ppos;light=new PointLight;light.ppos.set(A[0],A[1],A[2])}t=x.color;i=x.intensity||1;light.color.setRGB(t[0]*i,t[1]*i,t[2]*i);J.scene.addLight(light);J.lights[v]=light}for(m in F.fogs){v=F.fogs[m];if(v.type=="linear")P=new Fog(0,v.near,v.far);else if(v.type=="exp2")P=new FogExp2(0,v.density);t=v.color;P.color.setRGB(t[0],t[1],t[2]);J.fogs[m]=P}if(J.CCs&&F.defaults.CC)J.currentCamera=J.CCs[F.defaults.CC];
if(J.fogs&&F.defaults.fog)J.scene.fog=J.fogs[F.defaults.fog];t=F.defaults.bgcolor;J.bgColor=new Color;J.bgColor.setRGB(t[0],t[1],t[2]);J.bgColorAlpha=F.defaults.bgalpha;for(k in F.geometries){m=F.geometries[k];if(m.type=="bin_mesh"||m.type=="ascii_mesh")T+=1}S=T;for(k in F.geometries){m=F.geometries[k];if(m.type=="cube"){D=new Cube(m.width,m.height,m.depth,m.segments_width,m.segments_height,null,m.flipped,m.sides);J.geometries[k]=D}else if(m.type=="plane"){D=new Plane(m.width,m.height,m.segments_width,
m.segments_height);J.geometries[k]=D}else if(m.type=="sphere"){D=new SS(m.radius,m.segments_width,m.segments_height);J.geometries[k]=D}else if(m.type=="cylinder"){D=new Cylinder(m.numSegs,m.topRad,m.botRad,m.height,m.topOffset,m.botOffset);J.geometries[k]=D}else if(m.type=="torus"){D=new Torus(m.radius,m.tube,m.segmentsR,m.segmentsT);J.geometries[k]=D}else if(m.type=="icosahedron"){D=new Icosahedron(m.subdivisions);J.geometries[k]=D}else if(m.type=="bin_mesh")L.loadBinary({model:m.url,callback:j(k)});
else m.type=="ascii_mesh"&&L.loadAscii({model:m.url,callback:j(k)})}for(y in F.textures){k=F.textures[y];N+=k.url instanceof Array?k.url.length:1}R=N;for(y in F.textures){k=F.textures[y];if(k.mapping!=undefined&&THREE[k.mapping]!=undefined)k.mapping=new THREE[k.mapping];if(k.url instanceof Array){m=ImageUtils.loadArray(k.url,f);m=new Texture(m,k.mapping)}else{m=ImageUtils.lT(k.url,k.mapping,f);if(THREE[k.min_filter]!=undefined)m.min_filter=THREE[k.min_filter];if(THREE[k.mag_filter]!=
undefined)m.mag_filter=THREE[k.mag_filter]}J.textures[y]=m}for(q in F.mTs){y=F.mTs[q];for(I in y.parameters)if(I=="env_map"||I=="map"||I=="light_map")y.parameters[I]=J.textures[y.parameters[I]];else if(I=="shading")y.parameters[I]=y.parameters[I]=="flat"?FlatShading:SmoothShading;else if(I=="blending")y.parameters[I]=THREE[y.parameters[I]]?THREE[y.parameters[I]]:NormalBlending;else if(I=="combine")y.parameters[I]=y.parameters[I]=="MixOperation"?MixOperation:MultiplyOperation;
y=new THREE[y.type](y.parameters);J.mTs[q]=y}g();b(J)}},addMesh:function(a,b,c,d,f,g,j,l,k,q){b=new Mesh(b,q);b.sC.x=b.sC.y=b.sC.z=c;b.ppos.x=d;b.ppos.y=f;b.ppos.z=g;b.rt.x=j;b.rt.y=l;b.rt.z=k;a.addoB(b);return b},addPanoramaCubeWebGL:function(a,b,c){var d=ShaderUtils.lib.cube;d.uniforms.tCube.texture=c;c=new MeshShaderMt({fragment_shader:d.fragment_shader,vertex_shader:d.vertex_shader,uniforms:d.uniforms});b=new Mesh(new Cube(b,
b,b,1,1,null,true),c);a.addoB(b);return b},addPanoramaCube:function(a,b,c){var d=[];d.push(new mBm({map:new Texture(c[0])}));d.push(new mBm({map:new Texture(c[1])}));d.push(new mBm({map:new Texture(c[2])}));d.push(new mBm({map:new Texture(c[3])}));d.push(new mBm({map:new Texture(c[4])}));d.push(new mBm({map:new Texture(c[5])}));b=new Mesh(new Cube(b,
b,b,1,1,d,true),new MeshFaceMt);a.addoB(b);return b},addPanoramaCubePlanes:function(a,b,c){var d=b/2;b=new Plane(b,b);var f=Math.PI/2,g=Math.PI;SceneUtils.addMesh(a,b,1,0,0,-d,0,0,0,new mBm({map:new Texture(c[5])}));SceneUtils.addMesh(a,b,1,-d,0,0,0,f,0,new mBm({map:new Texture(c[0])}));SceneUtils.addMesh(a,b,1,d,0,0,0,-f,0,new mBm({map:new Texture(c[1])}));SceneUtils.addMesh(a,b,1,0,d,0,f,0,g,new mBm({map:new Texture(c[2])}));
SceneUtils.addMesh(a,b,1,0,-d,0,-f,0,g,new mBm({map:new Texture(c[3])}))}},ShaderUtils={lib:{fresnel:{uniforms:{mRefractionRatio:{type:"f",value:1.02},mFresnelBias:{type:"f",value:0.1},mFresnelPower:{type:"f",value:2},mFresnelScale:{type:"f",value:1},tCube:{type:"t",value:1,texture:null}},fragment_shader:"uniform samplerCube tCube;\nvarying vec3 vReflect;\nvarying vec3 vRefract[3];\nvarying float vReflectionFactor;\nvoid main() {\nvec4 reflectedColor = textureCube( tCube, vec3( -vReflect.x, vReflect.yz ) );\nvec4 refractedColor = vec4( 1.0, 1.0, 1.0, 1.0 );\nrefractedColor.r = textureCube( tCube, vec3( -vRefract[0].x, vRefract[0].yz ) ).r;\nrefractedColor.g = textureCube( tCube, vec3( -vRefract[1].x, vRefract[1].yz ) ).g;\nrefractedColor.b = textureCube( tCube, vec3( -vRefract[2].x, vRefract[2].yz ) ).b;\nrefractedColor.a = 1.0;\ngl_FragColor = mix( refractedColor, reflectedColor, clamp( vReflectionFactor, 0.0, 1.0 ) );\n}",
vertex_shader:"uniform float mRefractionRatio;\nuniform float mFresnelBias;\nuniform float mFresnelScale;\nuniform float mFresnelPower;\nvarying vec3 vReflect;\nvarying vec3 vRefract[3];\nvarying float vReflectionFactor;\nvoid main() {\nvec4 mvPosition = modelViewMatrix * vec4( ppos, 1.0 );\nvec4 mPosition = objectMatrix * vec4( ppos, 1.0 );\nvec3 nWorld = normalize ( mat3( objectMatrix[0].xyz, objectMatrix[1].xyz, objectMatrix[2].xyz ) * normal );\nvec3 I = mPosition.xyz - CCPosition;\nvReflect = reflect( I, nWorld );\nvRefract[0] = refract( normalize( I ), nWorld, mRefractionRatio );\nvRefract[1] = refract( normalize( I ), nWorld, mRefractionRatio * 0.99 );\nvRefract[2] = refract( normalize( I ), nWorld, mRefractionRatio * 0.98 );\nvReflectionFactor = mFresnelBias + mFresnelScale * pow( 1.0 + dot( normalize( I ), nWorld ), mFresnelPower );\ngl_Position = pM * mvPosition;\n}"},
normal:{uniforms:{enableAO:{type:"i",value:0},enableDiffuse:{type:"i",value:0},tDiffuse:{type:"t",value:0,texture:null},tNormal:{type:"t",value:2,texture:null},tAO:{type:"t",value:3,texture:null},uNormalScale:{type:"f",value:1},tDisplacement:{type:"t",value:4,texture:null},uDisplacementBias:{type:"f",value:-0.5},uDisplacementScale:{type:"f",value:2.5},uPointLightPos:{type:"v3",value:new v3},uPointLightColor:{type:"c",value:new Color(15658734)},uDirLightPos:{type:"v3",value:new v3},
uDirLightColor:{type:"c",value:new Color(15658734)},uAmbientLightColor:{type:"c",value:new Color(328965)},uDiffuseColor:{type:"c",value:new Color(15658734)},uSpecularColor:{type:"c",value:new Color(1118481)},uAmbientColor:{type:"c",value:new Color(328965)},uShininess:{type:"f",value:30}},fragment_shader:"uniform vec3 uDirLightPos;\nuniform vec3 uAmbientLightColor;\nuniform vec3 uDirLightColor;\nuniform vec3 uPointLightColor;\nuniform vec3 uAmbientColor;\nuniform vec3 uDiffuseColor;\nuniform vec3 uSpecularColor;\nuniform float uShininess;\nuniform bool enableDiffuse;\nuniform bool enableAO;\nuniform sampler2D tDiffuse;\nuniform sampler2D tNormal;\nuniform sampler2D tAO;\nuniform float uNormalScale;\nvarying vec3 vTangent;\nvarying vec3 vBinormal;\nvarying vec3 vNormal;\nvarying vec2 vUv;\nvarying vec3 vPointLightVector;\nvarying vec3 vViewPosition;\nvoid main() {\nvec3 diffuseTex = vec3( 1.0, 1.0, 1.0 );\nvec3 aoTex = vec3( 1.0, 1.0, 1.0 );\nvec3 normalTex = texture2D( tNormal, vUv ).xyz * 2.0 - 1.0;\nnormalTex.xy *= uNormalScale;\nnormalTex = normalize( normalTex );\nif( enableDiffuse )\ndiffuseTex = texture2D( tDiffuse, vUv ).xyz;\nif( enableAO )\naoTex = texture2D( tAO, vUv ).xyz;\nmat3 tsb = mat3( vTangent, vBinormal, vNormal );\nvec3 finalNormal = tsb * normalTex;\nvec3 normal = normalize( finalNormal );\nvec3 viewPosition = normalize( vViewPosition );\nvec4 pointDiffuse  = vec4( 0.0, 0.0, 0.0, 0.0 );\nvec4 pointSpecular = vec4( 0.0, 0.0, 0.0, 0.0 );\nvec3 pointVector = normalize( vPointLightVector );\nvec3 pointHalfVector = normalize( vPointLightVector + vViewPosition );\nfloat pointDotNormalHalf = dot( normal, pointHalfVector );\nfloat pointDiffuseWeight = max( dot( normal, pointVector ), 0.0 );\nfloat pointSpecularWeight = 0.0;\nif ( pointDotNormalHalf >= 0.0 )\npointSpecularWeight = pow( pointDotNormalHalf, uShininess );\npointDiffuse  += vec4( uDiffuseColor, 1.0 ) * pointDiffuseWeight;\npointSpecular += vec4( uSpecularColor, 1.0 ) * pointSpecularWeight;\nvec4 dirDiffuse  = vec4( 0.0, 0.0, 0.0, 0.0 );\nvec4 dirSpecular = vec4( 0.0, 0.0, 0.0, 0.0 );\nvec4 lDirection = viewMatrix * vec4( uDirLightPos, 0.0 );\nvec3 dirVector = normalize( lDirection.xyz );\nvec3 dirHalfVector = normalize( lDirection.xyz + vViewPosition );\nfloat dirDotNormalHalf = dot( normal, dirHalfVector );\nfloat dirDiffuseWeight = max( dot( normal, dirVector ), 0.0 );\nfloat dirSpecularWeight = 0.0;\nif ( dirDotNormalHalf >= 0.0 )\ndirSpecularWeight = pow( dirDotNormalHalf, uShininess );\ndirDiffuse  += vec4( uDiffuseColor, 1.0 ) * dirDiffuseWeight;\ndirSpecular += vec4( uSpecularColor, 1.0 ) * dirSpecularWeight;\nvec4 totalLight = vec4( uAmbientLightColor * uAmbientColor, 1.0 );\ntotalLight += vec4( uDirLightColor, 1.0 ) * ( dirDiffuse + dirSpecular );\ntotalLight += vec4( uPointLightColor, 1.0 ) * ( pointDiffuse + pointSpecular );\ngl_FragColor = vec4( totalLight.xyz * aoTex * diffuseTex, 1.0 );\n}",
vertex_shader:"attribute vec4 tangent;\nuniform vec3 uPointLightPos;\n#ifdef VERTEX_TEXTURES\nuniform sampler2D tDisplacement;\nuniform float uDisplacementScale;\nuniform float uDisplacementBias;\n#endif\nvarying vec3 vTangent;\nvarying vec3 vBinormal;\nvarying vec3 vNormal;\nvarying vec2 vUv;\nvarying vec3 vPointLightVector;\nvarying vec3 vViewPosition;\nvoid main() {\nvec4 mPosition = objectMatrix * vec4( ppos, 1.0 );\nvViewPosition = CCPosition - mPosition.xyz;\nvec4 mvPosition = modelViewMatrix * vec4( ppos, 1.0 );\nvNormal = normalize( normalMatrix * normal );\nvTangent = normalize( normalMatrix * tangent.xyz );\nvBinormal = cross( vNormal, vTangent ) * tangent.w;\nvBinormal = normalize( vBinormal );\nvUv = uv;\nvec4 lPosition = viewMatrix * vec4( uPointLightPos, 1.0 );\nvPointLightVector = normalize( lPosition.xyz - mvPosition.xyz );\n#ifdef VERTEX_TEXTURES\nvec3 dv = texture2D( tDisplacement, uv ).xyz;\nfloat df = uDisplacementScale * dv.x + uDisplacementBias;\nvec4 displacedPosition = vec4( vNormal.xyz * df, 0.0 ) + mvPosition;\ngl_Position = pM * displacedPosition;\n#else\ngl_Position = pM * mvPosition;\n#endif\n}"},
cube:{uniforms:{tCube:{type:"t",value:1,texture:null}},vertex_shader:"varying vec3 vViewPosition;\nvoid main() {\nvec4 mPosition = objectMatrix * vec4( ppos, 1.0 );\nvViewPosition = CCPosition - mPosition.xyz;\ngl_Position = pM * modelViewMatrix * vec4( ppos, 1.0 );\n}",fragment_shader:"uniform samplerCube tCube;\nvarying vec3 vViewPosition;\nvoid main() {\nvec3 wPos = CCPosition - vViewPosition;\ngl_FragColor = textureCube( tCube, vec3( - wPos.x, wPos.yz ) );\n}"},convolution:{uniforms:{tDiffuse:{type:"t",
value:0,texture:null},uImageIncrement:{type:"v2",value:new Vector2(0.001953125,0)},cKernel:{type:"fv1",value:[]}},vertex_shader:"varying vec2 vUv;\nuniform vec2 uImageIncrement;\nvoid main(void) {\nvUv = uv - ((KERNEL_SIZE - 1.0) / 2.0) * uImageIncrement;\ngl_Position = pM * modelViewMatrix * vec4( ppos, 1.0 );\n}",fragment_shader:"varying vec2 vUv;\nuniform sampler2D tDiffuse;\nuniform vec2 uImageIncrement;\nuniform float cKernel[KERNEL_SIZE];\nvoid main(void) {\nvec2 imageCoord = vUv;\nvec4 sum = vec4( 0.0, 0.0, 0.0, 0.0 );\nfor( int i=0; i<KERNEL_SIZE; ++i ) {\nsum += texture2D( tDiffuse, imageCoord ) * cKernel[i];\nimageCoord += uImageIncrement;\n}\ngl_FragColor = sum;\n}"},
film:{uniforms:{tDiffuse:{type:"t",value:0,texture:null},time:{type:"f",value:0},graysC:{type:"i",value:1}},vertex_shader:"varying vec2 vUv;\nvoid main() {\nvUv = vec2( uv.x, 1.0 - uv.y );\ngl_Position = pM * modelViewMatrix * vec4( ppos, 1.0 );\n}",fragment_shader:"varying vec2 vUv;\nuniform sampler2D tDiffuse;\nuniform float time;\nuniform bool graysC;\nconst float fNintensity = 0.35;\nconst float fSintensity = 0.35;\nconst float fScount = 4096.0;\nvoid main() {\nvec4 cTextureScreen = texture2D( tDiffuse, vUv );\nfloat x = vUv.x * vUv.y * time *  1000.0;\nx = mod( x, 13.0 ) * mod( x, 123.0 );\nfloat dx = mod( x, 0.01 );\nvec3 cResult = cTextureScreen.rgb + cTextureScreen.rgb * clamp( 0.1 + dx * 100.0, 0.0, 1.0 );\nvec2 sc = vec2( sin(vUv.y * fScount), cos(vUv.y * fScount) );\ncResult += cTextureScreen.rgb * vec3( sc.x, sc.y, sc.x ) * fSintensity;\ncResult = cTextureScreen.rgb + clamp( fNintensity, 0.0,1.0 ) * ( cResult - cTextureScreen.rgb );\nif( graysC ) {\ncResult = vec3( cResult.r * 0.3 + cResult.g * 0.59 + cResult.b * 0.11 );\n}\ngl_FragColor =  vec4( cResult, cTextureScreen.a );\n}"},
screen:{uniforms:{tDiffuse:{type:"t",value:0,texture:null},op:{type:"f",value:1}},vertex_shader:"varying vec2 vUv;\nvoid main() {\nvUv = vec2( uv.x, 1.0 - uv.y );\ngl_Position = pM * modelViewMatrix * vec4( ppos, 1.0 );\n}",fragment_shader:"varying vec2 vUv;\nuniform sampler2D tDiffuse;\nuniform float op;\nvoid main() {\nvec4 texel = texture2D( tDiffuse, vUv );\ngl_FragColor = op * texel;\n}"},basic:{uniforms:{},vertex_shader:"void main() {\ngl_Position = pM * modelViewMatrix * vec4( ppos, 1.0 );\n}",
fragment_shader:"void main() {\ngl_FragColor = vec4( 1.0, 0.0, 0.0, 0.5 );\n}"}},buildKernel:function(a){var b,c,d,f,g=2*Math.ceil(a*3)+1;if(g>25)g=25;f=(g-1)*0.5;c=Array(g);for(b=d=0;b<g;++b){c[b]=Math.exp(-((b-f)*(b-f))/(2*a*a));d+=c[b]}for(b=0;b<g;++b)c[b]/=d;return c}},Cube=function(a,b,c,d,f,g,j,l){function k(B,A,t,I,D,e,P,U){var F,L,T=d||1,N=f||1,S=T+1,R=N+1,J=D/2,E=e/2;D/=T;var Y=e/N,M=q.vts.length;if(B=="x"&&A=="y"||B=="y"&&A=="x")F="z";else if(B=="x"&&A=="z"||B=="z"&&A=="x")F="y";else if(B==
"z"&&A=="y"||B=="y"&&A=="z")F="x";for(L=0;L<R;L++)for(e=0;e<S;e++){var X=new v3;X[B]=(e*D-J)*t;X[A]=(L*Y-E)*I;X[F]=P;q.vts.push(new Vertex(X))}for(L=0;L<N;L++)for(e=0;e<T;e++){q.faces.push(new Face4(e+S*L+M,e+S*(L+1)+M,e+1+S*(L+1)+M,e+1+S*L+M,null,U));q.uvs.push([new UV(e/T,L/N),new UV(e/T,(L+1)/N),new UV((e+1)/T,(L+1)/N),new UV((e+1)/T,L/N)])}}GG.call(this);var q=this,w=a/2,v=b/2,x=c/2;j=j?-1:1;if(g!==undefined)if(g instanceof Array)this.mTs=
g;else{this.mTs=[];for(var m=0;m<6;m++)this.mTs.push([g])}else this.mTs=[];this.sides={px:true,nx:true,py:true,ny:true,pz:true,nz:true};if(l!=undefined)for(var y in l)if(this.sides[y]!=undefined)this.sides[y]=l[y];this.sides.px&&k("z","y",1*j,-1,c,b,-w,this.mTs[0]);this.sides.nx&&k("z","y",-1*j,-1,c,b,w,this.mTs[1]);this.sides.py&&k("x","z",1*j,1,a,c,v,this.mTs[2]);this.sides.ny&&k("x","z",1*j,-1,a,c,-v,this.mTs[3]);this.sides.pz&&k("x","y",1*j,-1,a,b,x,this.mTs[4]);
this.sides.nz&&k("x","y",-1*j,-1,a,b,-x,this.mTs[5]);(function(){for(var B=[],A=[],t=0,I=q.vts.length;t<I;t++){for(var D=q.vts[t],e=false,P=0,U=B.length;P<U;P++){var F=B[P];if(D.ppos.x==F.ppos.x&&D.ppos.y==F.ppos.y&&D.ppos.z==F.ppos.z){A[t]=P;e=true;break}}if(!e){A[t]=B.length;B.push(new Vertex(D.ppos.clone()))}}t=0;for(I=q.faces.length;t<I;t++){D=q.faces[t];D.a=A[D.a];D.b=A[D.b];D.c=A[D.c];D.d=A[D.d]}q.vts=B})();this.cMpCentroids();this.cMpFaceNormals();
this.sortFacesByMt()};Cube.prototype=new GG;Cube.prototype.constructor=Cube;
var Plane=function(a,b,c,d){GG.call(this);var f,g=a/2,j=b/2;c=c||1;d=d||1;var l=c+1,k=d+1;a/=c;var q=b/d;for(f=0;f<k;f++)for(b=0;b<l;b++)this.vts.push(new Vertex(new v3(b*a-g,-(f*q-j),0)));for(f=0;f<d;f++)for(b=0;b<c;b++){this.faces.push(new Face4(b+l*f,b+l*(f+1),b+1+l*(f+1),b+1+l*f));this.uvs.push([new UV(b/c,f/d),new UV(b/c,(f+1)/d),new UV((b+1)/c,(f+1)/d),new UV((b+1)/c,f/d)])}this.cMpCentroids();this.cMpFaceNormals();this.sortFacesByMt()};
Plane.prototype=new GG;Plane.prototype.constructor=Plane;
var SS=function(a,b,c){GG.call(this);var d,f=Math.PI,g=Math.max(3,b||8),j=Math.max(2,c||6);b=[];for(c=0;c<j+1;c++){d=c/j;var l=a*Math.cos(d*f),k=a*Math.sin(d*f),q=[],w=0;for(d=0;d<g;d++){var v=2*d/g,x=k*Math.sin(v*f);v=k*Math.cos(v*f);(c==0||c==j)&&d>0||(w=this.vts.push(new Vertex(new v3(v,l,x)))-1);q.push(w)}b.push(q)}var m,y,B;f=b.length;for(c=0;c<f;c++){g=b[c].length;if(c>0)for(d=0;d<g;d++){q=d==g-1;j=b[c][q?0:d+1];l=b[c][q?g-1:d];k=b[c-1][q?g-1:d];q=b[c-1][q?
0:d+1];x=c/(f-1);m=(c-1)/(f-1);y=(d+1)/g;v=d/g;w=new UV(1-y,x);x=new UV(1-v,x);v=new UV(1-v,m);var A=new UV(1-y,m);if(c<b.length-1){m=this.vts[j].ppos.clone();y=this.vts[l].ppos.clone();B=this.vts[k].ppos.clone();m.normalize();y.normalize();B.normalize();this.faces.push(new Face3(j,l,k,[new v3(m.x,m.y,m.z),new v3(y.x,y.y,y.z),new v3(B.x,B.y,B.z)]));this.uvs.push([w,x,v])}if(c>1){m=this.vts[j].ppos.clone();
y=this.vts[k].ppos.clone();B=this.vts[q].ppos.clone();m.normalize();y.normalize();B.normalize();this.faces.push(new Face3(j,k,q,[new v3(m.x,m.y,m.z),new v3(y.x,y.y,y.z),new v3(B.x,B.y,B.z)]));this.uvs.push([w,v,A])}}}this.cMpCentroids();this.cMpFaceNormals();this.cMpVertexNormals();this.sortFacesByMt();this.bS={radius:a}};SS.prototype=new GG;SS.prototype.constructor=SS;
function lO(a,b,c){GG.call(this);b=b||12;c=c||2*Math.PI;b=c/b;for(var d=[],f=[],g=[],j=[],l=0;l<a.length;l++){this.vts.push(new Vertex(a[l]));f[l]=this.vts.length-1;d[l]=new v3(a[l].x,a[l].y,a[l].z)}for(var k=m4.rtZMatrix(b),q=0;q<=c+0.0010;q+=b){for(l=0;l<d.length;l++)if(q<c){d[l]=k.mV3(d[l].clone());this.vts.push(new Vertex(d[l]));g[l]=this.vts.length-1}else g=j;if(q==0)j=f;for(l=0;l<f.length-1;l++){this.faces.push(new Face4(g[l],
g[l+1],f[l+1],f[l]));this.uvs.push([new UV(q/c,l/a.length),new UV(q/c,(l+1)/a.length),new UV((q-b)/c,(l+1)/a.length),new UV((q-b)/c,l/a.length)])}f=g;g=[]}this.cMpCentroids();this.cMpFaceNormals();this.cMpVertexNormals();this.sortFacesByMt()}lO.prototype=new GG;lO.prototype.constructor=lO;var Stats=function(){function a(M,X,h){var o,u,n;for(u=0;u<30;u++)for(o=0;o<73;o++){n=(o+u*74)*4;M[n]=M[n+4];M[n+1]=M[n+5];M[n+2]=M[n+6]}for(u=0;u<30;u++){n=(73+u*74)*4;if(u<X){M[n]=E[h].bg.r;M[n+1]=E[h].bg.g;M[n+2]=E[h].bg.b}else{M[n]=E[h].fg.r;M[n+1]=E[h].fg.g;M[n+2]=E[h].fg.b}}}var b=0,c=2,d,f=0,g=(new Date).getTime(),j=g,l=g,k=0,q=1E3,w=0,v,x,m,y,B,A=0,t=1E3,I=0,D,e,P,U,F=0,L=1E3,T=0,N,S,R,J,E={fps:{bg:{r:16,g:16,b:48},fg:{r:0,g:255,b:255}},ms:{bg:{r:16,g:48,b:16},fg:{r:0,g:255,b:0}},mem:{bg:{r:48,
g:16,b:26},fg:{r:255,g:0,b:128}}};d=document.createElement("div");d.style.cursor="pointer";d.style.width="80px";d.style.op="0.9";d.style.zIndex="10001";d.addEventListener("click",function(){b++;b==c&&(b=0);v.style.display="none";D.style.display="none";N.style.display="none";switch(b){case 0:v.style.display="block";break;case 1:D.style.display="block";break;case 2:N.style.display="block"}},false);v=document.createElement("div");v.style.backgroundColor="rgb("+Math.floor(E.fps.bg.r/2)+","+Math.floor(E.fps.bg.g/
2)+","+Math.floor(E.fps.bg.b/2)+")";v.style.padding="2px 0px 3px 0px";d.appendChild(v);x=document.createElement("div");x.style.fontFamily="Helvetica, Arial, sans-serif";x.style.textAlign="left";x.style.fontSize="9px";x.style.color="rgb("+E.fps.fg.r+","+E.fps.fg.g+","+E.fps.fg.b+")";x.style.margin="0px 0px 1px 3px";x.innerHTML='<span style="font-weight:bold">FPS</span>';v.appendChild(x);m=document.createElement("canvas");m.width=74;m.height=30;m.style.display="block";m.style.marginLeft="3px";v.appendChild(m);
y=m.getContext("2d");y.fillStyle="rgb("+E.fps.bg.r+","+E.fps.bg.g+","+E.fps.bg.b+")";y.fillRect(0,0,m.width,m.height);B=y.getImageData(0,0,m.width,m.height);D=document.createElement("div");D.style.backgroundColor="rgb("+Math.floor(E.ms.bg.r/2)+","+Math.floor(E.ms.bg.g/2)+","+Math.floor(E.ms.bg.b/2)+")";D.style.padding="2px 0px 3px 0px";D.style.display="none";d.appendChild(D);e=document.createElement("div");e.style.fontFamily="Helvetica, Arial, sans-serif";e.style.textAlign="left";e.style.fontSize=
"9px";e.style.color="rgb("+E.ms.fg.r+","+E.ms.fg.g+","+E.ms.fg.b+")";e.style.margin="0px 0px 1px 3px";e.innerHTML='<span style="font-weight:bold">MS</span>';D.appendChild(e);m=document.createElement("canvas");m.width=74;m.height=30;m.style.display="block";m.style.marginLeft="3px";D.appendChild(m);P=m.getContext("2d");P.fillStyle="rgb("+E.ms.bg.r+","+E.ms.bg.g+","+E.ms.bg.b+")";P.fillRect(0,0,m.width,m.height);U=P.getImageData(0,0,m.width,m.height);try{if(webkitPerformance&&webkitPerformance.memory.totalJSHeapSize)c=
3}catch(Y){}N=document.createElement("div");N.style.backgroundColor="rgb("+Math.floor(E.mem.bg.r/2)+","+Math.floor(E.mem.bg.g/2)+","+Math.floor(E.mem.bg.b/2)+")";N.style.padding="2px 0px 3px 0px";N.style.display="none";d.appendChild(N);S=document.createElement("div");S.style.fontFamily="Helvetica, Arial, sans-serif";S.style.textAlign="left";S.style.fontSize="9px";S.style.color="rgb("+E.mem.fg.r+","+E.mem.fg.g+","+E.mem.fg.b+")";S.style.margin="0px 0px 1px 3px";S.innerHTML='<span style="font-weight:bold">MEM</span>';
N.appendChild(S);m=document.createElement("canvas");m.width=74;m.height=30;m.style.display="block";m.style.marginLeft="3px";N.appendChild(m);R=m.getContext("2d");R.fillStyle="#301010";R.fillRect(0,0,m.width,m.height);J=R.getImageData(0,0,m.width,m.height);return{domElement:d,update:function(){f++;g=(new Date).getTime();A=g-j;t=Math.min(t,A);I=Math.max(I,A);a(U.data,Math.min(30,30-A/200*30),"ms");e.innerHTML='<span style="font-weight:bold">'+A+" MS</span> ("+t+"-"+I+")";P.putImageData(U,0,0);j=g;if(g>
l+1E3){k=Math.round(f*1E3/(g-l));q=Math.min(q,k);w=Math.max(w,k);a(B.data,Math.min(30,30-k/100*30),"fps");x.innerHTML='<span style="font-weight:bold">'+k+" FPS</span> ("+q+"-"+w+")";y.putImageData(B,0,0);if(c==3){F=webkitPerformance.memory.usedJSHeapSize*9.54E-7;L=Math.min(L,F);T=Math.max(T,F);a(J.data,Math.min(30,30-F/2),"mem");S.innerHTML='<span style="font-weight:bold">'+Math.round(F)+" MEM</span> ("+Math.round(L)+"-"+Math.round(T)+")";R.putImageData(J,0,0)}l=g;f=0}}}};(function(a,b,c,d,f,g,j){function l(w){var v,x,m=this,y=w.length,B=0,A=m.i=m.j=m.m=0;m.S=[];m.c=[];for(y||(w=[y++]);B<c;)m.S[B]=B++;for(B=0;B<c;B++){v=m.S[B];A=A+v+w[B%y]&c-1;x=m.S[A];m.S[B]=x;m.S[A]=v}m.g=function(t){var I=m.S,D=m.i+1&c-1,e=I[D],P=m.j+e&c-1,U=I[P];I[D]=U;I[P]=e;for(var F=I[e+U&c-1];--t;){D=D+1&c-1;e=I[D];P=P+e&c-1;U=I[P];I[D]=U;I[P]=e;F=F*c+I[e+U&c-1]}m.i=D;m.j=P;return F};m.g(c)}function k(w,v,x,m){x=[];if(v&&typeof w=="object")for(m in w)if(m.indexOf("S")<5)try{x.push(k(w[m],v-
1))}catch(y){}return x.length?x:""+w}function q(w,v,x,m){w+="";for(m=x=0;m<w.length;m++){var y=v,B=m&c-1,A=(x^=v[m&c-1]*19)+w.charCodeAt(m);y[B]=A&c-1}w="";for(m in v)w+=String.fromCharCode(v[m]);return w}b.seedrandom=function(w,v){var x=[],m;w=q(k(v?[w,a]:arguments.length?w:[(new Date).getTime(),a,window],3),x);m=new l(x);q(m.S,a);b.random=function(){for(var y=m.g(d),B=j,A=0;y<f;){y=(y+A)*c;B*=c;A=m.g(1)}for(;y>=g;){y/=2;B/=2;A>>>=1}return(y+A)/B};return w};j=b.pow(c,d);f=b.pow(2,f);g=f*2;q(b.random(),
a)})([],Math,256,6,52);function rnd(){return Math.random()}function rndV(){return new v3(rnd(),rnd(),rnd())}function rndV2(){tempV.set(rnd(),rnd(),rnd());return tempV}function gup(a){a=RegExp("[\\?&]"+a+"=([^&#]*)").exec(window.location.href);if(a!=null)return a[1];return null}function ibc(){try{new Float32Array(1)}catch(a){return false}return true}function time(){return(new Date).getTime()}var aq="L",cpu=gup("cpu");if(cpu==null)cpu="default";
if(cpu=="default"){starsBgImage=undefined;nstars=2E4}else if(cpu=="fast"){starsBgImage="textures/stars_blend.jpg";nstars=2E4}else if(cpu=="medium"){starsBgImage="textures/stars_blend2.jpg";nstars=2E3}else if(cpu=="slow"){starsBgImage="textures/stars_blend3.jpg";nstars=0}
function dec(a){var b="",c,d,f,g,j,l=0;for(a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");l<a.length;){c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(l++));d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(l++));g="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(l++));j="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(l++));c=c<<2|d>>4;d=(d&15)<<4|g>>2;f=(g&3)<<
6|j;b+=String.fromCharCode(c);if(g!=64)b+=String.fromCharCode(d);if(j!=64)b+=String.fromCharCode(f)}return b}function debug(a){document.getElementById("debug").innerHTML=a}function show(a){document.getElementById(a).style.display=""}function hide(a){document.getElementById(a).style.display="none"}var Ws=gup("size");if(Ws==null)Ws=10;var nASs=gup("nast");if(nASs==null)nASs=100;var speed=gup("speed");if(speed==null)speed=5;
var _AS=1,_sH=2,_UFO=3,_Tr=4,_E=5,_M=6,starFaces=[new Face3(0,1,2),new Face3(2,1,0)];function Star(a){GG.call(this);this.vts=[new Vertex(new v3(0,0,0)),new Vertex(new v3(a,0,0)),new Vertex(new v3(a/2,-a/2,0))];this.faces=starFaces}Star.prototype=new GG;Star.prototype.constructor=Star;aq+="2";function lI(a){var b=new Image;b.onload=function(){this.loaded=true};b.src=a;return b}
function lT(a,b,c){image=lI(a);a=c!==undefined?NearestFilter:LinearFilter;return new mLm({color:b,shading:SmoothShading,map:new Texture(image,new UVMapping,ClampToEdgeWrapping,NearestFilter,a)})}function prepoB(a){a.um();a.aum=false;scene.addoB(a)}aq+="F";
function CrRenderer(a){if(a==0)renderer=new WebGLRenderer({scene:scene});renderer.setSize(window.innerWidth,window.innerHeight);container=document.getElementById("main_canvas");container.appendChild(renderer.domElement);renderer.type=a;return renderer}var CC,CCFollowssH,scene,renderer,score=0,maxScore=-999999,nsHs=-1,nUFOs=0,EE=1E4,ww=window.location.href,UTime,E,M,sH,ASs=[],ASCount=[0,0,0],container,stats,tempV=new v3,tempM=new m4;
aq+="z";
function ia(){if(ww.indexOf(dec(aq))!=-1){if(nASs==undefined)nASs=40;hide("gameOver");document.getElementById("gameOver").innerHTML="Game Over!";CCFollowssH=true;CC=new Camera(60,window.innerWidth/window.innerHeight,1,12505*Ws);CC.ppos.set(0,130*Ws,1E3*Ws);CC.rt=new v3(0,Math.sin(CC.ppos.y/CC.ppos.z),0);CC.aum=false;CC.um();scene=new Scene;if(ww.indexOf(dec(aq))!=-1){CrStars(nstars,
true,starsBgImage!==undefined);scene.addLight(new AmbientLight(2236962));var a=new DirectionalLight(15663069,1.6);a.ppos.set(1,1,1);scene.addLight(a);if(ww.indexOf(dec(aq))!=-1){a=new SS(1,12,12);var b=new Mesh(a,new mBm({color:15663069,ambient:15663069}));b.sC.set(200,200,200).ms(Ws);b.ppos.set(4500,4500,4500).ms(Ws);prepoB(b);b=lT("textures/land_ocean_ice_cloud_1024.jpg",16777215);E=new Mesh(a,
b);E.sC.set(100,100,100).ms(Ws);E.rt.x=Math.sin(26*Math.PI/180);E.cT=_E;E.gG.cMpBoundingSS();cMpCOM(E);prepoB(E);if(ww.indexOf(dec(aq))!=-1){M=new Mesh(a,lT("textures/JVV.Moon2.jpg",16777215,true));M.sC.set(30,30,30).ms(Ws);M.ppos.x=500*Ws;M.orbitAngle=0;M.cT=_M;M.gG.cMpBoundingSS();cMpCOM(M);prepoB(M);if(ww.indexOf(dec(aq))!=
-1){for(a=0;a<nASs;a++)CrAS(Math.floor(rnd()*2.99));updateAstCount();nsHs=3;sH=CrsH();sH.ppos.z=800*Ws;sH.um();sH.rot=new v3;UTime=time()+3E4*Math.random()+2E4;renderer=CrRenderer(0);document.addEventListener("mousemove",onDocumentMouseMove,false);document.addEventListener("mousedown",onDocumentMouseDown,false);document.addEventListener("mouseup",onDocumentMouseUp,false);document.addEventListener("keydown",onDocumentKeyDown,false);
document.addEventListener("keyup",onDocumentKeyUp,false);setInterval(la,25);CrEx(tempV.set(0,0,0),{nShards:0,color:0,maxDist:10,doLight:false}).sC.set(0.01,0.01,0.01);stats=new Stats;stats.domElement.style.position="absolute";stats.domElement.style.top="0px";container.appendChild(stats.domElement);is(0);document.getElementById("Lives").innerHTML="Lives: "+nsHs;document.getElementById("UFOs").innerHTML="UFOs: "+nUFOs;document.getElementById("Energy").innerHTML=
"Energy: "+EE}}}}}}var ASTextures=[],ASGeoms=[[],[],[]];aq+="d";
function CrAS(a){for(var b=null,c=0;c<ASs.length;c++)if(!ASs[c].vs&&ASs[c].index==a){b=ASs[c];b.vs=true;break}if(b==null){radius=60;color=11158698;nVerts=10;if(a==0){color=11184708;radius=20;nVerts=4}else if(a==1){color=4500138;radius=40;nVerts=8}else if(a==2){color=11158698;radius=60;nVerts=10}if(ASTextures[a]==null)ASTextures[a]=lT("textures/meteor2.jpg",color);if(ASGeoms[a].length>5)b=ASGeoms[a][Math.floor(rnd()*5)];else{b=
ASGeoms[a][ASGeoms[a].length]=new SS(1,nVerts,nVerts);for(c=0;c<b.vts.length;c++)b.vts[c].ppos.mS(rndV2().aSc(-0.5).ms(0.75).aSc(1));b.cMpCentroids();b.cMpFaceNormals();b.cMpVertexNormals();b.sortFacesByMt();b.cMpBoundingSS()}b=new Mesh(b,ASTextures[a]);b.sC.set(rnd(),rnd(),rnd()).aSc(-0.5).ms(1).aSc(1);b.sC.setLength(radius*Math.sqrt(Ws));b.ppos.set(rnd(),
rnd(),rnd()).aSc(-0.5).setLength(2E3*Ws);b.rt.set(rnd(),rnd(),rnd()).aSc(-0.5).setLength(2);b.V=rndV().aSc(-0.5);b.V.ms(100/radius*speed);b.rV=(rnd()+0.5)*2/radius;if(rnd()<0.5)b.rV*=-1;b.rA=rnd()*2*Math.PI;b.rotAxis=rndV().normalize();b.index=a;b.cT=_AS;cMpCOM(b);ASs.push(b);b.color=color;b.vs=true}ASCount[b.index]++;prepoB(b);return b}aq+="H";
function CrsH(){var a=[new v3(0,0.0010,-0.9),new v3(0.02,0,-0.89),new v3(0.02,0,-0.8),new v3(0.2,0,-0.7),new v3(0.26,0,-0.544),new v3(0.32,0,-0.38),new v3(0.38,0,-0.22),new v3(0.44,0,-0.06),new v3(0.5,0,0.1),new v3(0.5,0,0.3),new v3(0.45,0,0.3),new v3(0.1,0,0.2),new v3(0,0.0010,0.2)];sH=new Mesh(new lO(a,12),lT("textures/rivets2.jpg",
13434845,true));sH.sC.set(5,5,7.5).ms(1*Math.sqrt(Ws));sH.ppos.z=800*Ws;sH.V=new v3(0,0,0);sH.rV=new v3(0,0,0);sH.color=13434845;sH.window=new Mesh(new SS(0.2,8,8),new mQm({color:6711022,specular:11184810,shininess:300,rfl:0.8,op:0.8,blending:AdditiveBlending,shading:SmoothShading}));for(a=0;a<sH.window.gG.vts.length;a++)sH.window.gG.vts[a].ppos.aS(tempV.set(0,
0.32,-0.05));sH.window.matrix=sH.matrix;sH.window.aum=false;sH.sH=new Mesh(new SS(1.1,12,12),new mQm({ambient:2254404,color:2263142,specular:11158596,shininess:300,rfl:0.6,op:0.4,refraction_ratio:0.7,blending:AdditiveBlending,shading:SmoothShading}));for(a=0;a<sH.sH.gG.vts.length;a++)sH.sH.gG.vts[a].ppos.z-=0.15;sH.sH.matrix=sH.matrix;sH.sH.aum=sH.sH.vs=
false;sH.Th=[];a=new mBm({ambient:2237030,color:5592473,op:0.8,blending:AdditiveBlending,shading:FlatShading});sH.Th.fwd=new Mesh(new SS(0.1,8,8),a);sH.Th.lt=new Mesh(new SS(0.1,8,8),a);sH.Th.rt=new Mesh(new SS(0.1,8,8),a);for(a=0;a<sH.Th.fwd.gG.vts.length;a++){sH.Th.fwd.gG.vts[a].ppos.z+=0.25;sH.Th.lt.gG.vts[a].ppos.x-=0.5;sH.Th.rt.gG.vts[a].ppos.x+=
0.5}sH.Th.fwd.matrix=sH.Th.lt.matrix=sH.Th.rt.matrix=sH.matrix;sH.Th.fwd.aum=sH.Th.fwd.vs=false;sH.Th.lt.aum=sH.Th.rt.vs=false;sH.Th.rt.aum=sH.Th.lt.vs=false;a=lI("textures/crosshairs2.jpg");a=new mBm({op:0.6,color:5614165,blending:AdditiveBlending,shading:FlatShading,depth_test:false,map:new Texture(a,new UVMapping,
ClampToEdgeWrapping,NearestFilter,LinearFilter)});sH.cH=new Mesh(new Plane(10*Ws,10*Ws,1,1),a);for(a=0;a<sH.cH.gG.vts.length;a++)sH.cH.gG.vts[a].ppos.z-=75*Ws;sH.cH.matrix=sH.matrix;sH.cH.aum=false;sH.cH.vs=true;prepoB(sH);sH.gG.cMpBoundingSS();scene.addoB(sH.window);scene.addoB(sH.sH);scene.addoB(sH.Th.fwd);
scene.addoB(sH.Th.lt);scene.addoB(sH.Th.rt);scene.addoB(sH.cH);sH.cT=_sH;cMpCOM(sH);nsHs--;document.getElementById("Lives").innerHTML="Lives: "+nsHs;EE=1E4;document.getElementById("Energy").innerHTML="Energy: "+EE;return sH}var Us=[];aq+="J";
function CrUFO(a,b){if(a==undefined)if(rnd()<0.7){a=2;if(b==undefined)b=16759739}else{a=1.3;if(b==undefined)b=65280}for(var c=null,d=0;d<Us.length;d++)if(!Us[d].vs&&Us[d].size==a){c=Us[d];break}if(c==null){var f=a==2?10:8;c=new Mesh(new SS(1,f,f),lT("textures/space_panel2.jpg",b,true));for(d=0;d<c.gG.vts.length;d++)c.gG.vts[d].ppos.ms(a).mS(tempV.set(1,0.3,1));c.sC.ms(a*10*Math.sqrt(Ws));c.size=
a;c.color=b;c.window=new Mesh(new SS(1,f,f),new mQm({color:16776960,specular:11184810,shininess:300,rfl:0.8,op:0.8,blending:AdditiveBlending,shading:SmoothShading}));f=c.window.gG;for(d=0;d<f.vts.length;d++)f.vts[d].ppos.ms(a).mS(tempV.set(0.5,0.6,0.5));c.window.matrix=c.matrix;c.window.aum=false;c.lastShot=time();c.gG.cMpBoundingSS();c.V=new v3;changeUFODirection(c);
c.cT=_UFO;cMpCOM(c);scene.addoB(c.window);Us.push(c)}d=rnd();f=rnd()-0.5;var g=rnd()-0.5;if(d<=0.33){c.mainDirection=rnd()>0.5?1:-1;c.ppos.set(-1E3*c.mainDirection,f*2E3,g*2E3)}else if(d<=0.67){c.mainDirection=rnd()>0.5?1:-1;c.ppos.set(f*2E3,-1E3*c.mainDirection,g*2E3)}else{c.mainDirection=rnd()>0.5?1:-1;c.ppos.set(f*2E3,g*2E3,-1E3*c.mainDirection)}c.ppos.ms(Ws);nUFOs++;document.getElementById("UFOs").innerHTML="UFOs: "+nUFOs;c.vs=c.window.vs=
true;prepoB(c);return c}function changeUFODirection(a){if(Math.abs(a.mainDirection)==1)a.V.set(1.5*(a.mainDirection>0?1:-1),rnd(),rnd()).aSc(-0.5);else Math.abs(a.mainDirection)==2?a.V.set(rnd(),1.5*(a.mainDirection>0?1:-1),rnd()).aSc(-0.5):a.V.set(rnd(),rnd(),1.5*(a.mainDirection>0?1:-1)).aSc(-0.5);a.V.setLength(3/a.size*speed)}var starGeoms=[];aq+="v";
function CrStars(a,b,c){if(a>0){for(var d=[],f=new GG,g=0;g<a;g++){var j=Math.floor(rnd()*25)+13;if(d[g%10]==null){var l=20+Math.floor(rnd()*150);l=~~(l+Math.floor(rnd()*20))<<16^~~(l+Math.floor(rnd()*50))<<8^~~(l+Math.floor(rnd()*80));d[g%10]=new mBm({color:l,shading:FlatShading})}if(starGeoms.length<=j||starGeoms.size==null){l=starGeoms[j]=new Star(j*Ws);l.faces[0].mTs=l.faces[1].mTs=[d[g%10]]}j=new Mesh(starGeoms[j]);j.ppos.set(rnd(),
rnd(),rnd()).aSc(-0.5).setLength((5E3+rnd()*1E3)*Ws);j.rt.set(rnd(),rnd(),rnd()).setLength(2*Math.PI);GGUtils.merge(f,j)}f.sortFacesByMt();g=new Mesh(f,new MeshFaceMt);prepoB(g)}if(c&&starsBgImage!==undefined){var k=[];c=lI(starsBgImage);c.onload=function(){k.loadCount=6};for(g=c.loaded=0;g<6;g++)k[g]=c;c=new Texture(k,undefined,undefined,undefined,NearestFilter,NearestFilter);c=SceneUtils.addPanoramaCubeWebGL(scene,12500*
Ws,c);c.aum=false}if(b){c=new Mesh(new SS(4995*Ws),new mBm({color:1118515,wf:true,wf_lw:1}));prepoB(c)}}var exMts=null;aq+="Z";
function getExMt(a,b,c){if(a==undefined)a=0;if(c==undefined)c="textures/Explode-05-june-";if(exMts==null||exMts.length<a||exMts[a]==null){if(exMts==null)exMts=[];b="00"+a;if(a>=10)b="0"+a;c=lI(c+b+".jpg");out=new mBm({op:0.7,depth_test:false,blending:AdditiveBlending,shading:FlatShading,map:new Texture(c,new UVMapping,ClampToEdgeWrapping,NearestFilter,LinearFilter)});
exMts[a]=out}return exMts[a]}aq+="H";var exs=[],shardGeoms=[];
function CrEx(a,b){var c="textures/Explode-05-june-",d=25,f=11171652,g=new v3,j=18,l=true;if(b){if(b.path!==undefined)c=b.path;if(b.V!==undefined)g=b.V;if(b.nShards!==undefined)d=b.nShards;if(b.color!==undefined)f=b.color;if(b.maxDist!==undefined)j=b.maxDist;if(b.doLight!==undefined)l=b.doLight}var k=rnd()<0.5?-1:1;k=new Mesh(new Plane((50+rnd()*25)*k*Ws*0.5,(50+rnd()*25)*k*Ws*0.5,1,1),getExMt(0,f,c));k.ppos.cy(a);prepoB(k);
k.index=0;k.maxIndex=29;k.path=c;k.light=new PointLight(f,l?0.1:1.0E-5);k.light.ppos.cy(k.ppos);scene.addLight(k.light);k.color=f;c=false;for(l=0;l<exs.length;l++)if(exs[l]==null){exs[l]=k;c=true;break}c||exs.push(k);k.shards=[];for(c=0;c<d;c++){var q;l=new Color(f);rnd();if(c==0||c==Math.round(d/3)||c==Math.round(d*2/3)){if(c==Math.round(d/3)){l.r*=1.4;l.g*=1.4;l.b*=1.4}else if(c==Math.round(d*2/3)){l.r*=0.6;l.g*=0.6;l.b*=0.6}if(l.r>1)l.r=1;if(l.g>
1)l.g=1;if(l.b>1)l.b=1;l.updateHex();q=new mBm({color:l.hex,shading:FlatShading})}var w;if(shardGeoms.length<=c){w=new lO([new v3(0,0,0.07*1.5),new v3(0.05*1.5,0,-0.045),new v3(0,0,-0.045)],3);var v=w.vts;for(l=0;l<v.length;l++)v[l].ppos.mS(rndV2().aSc(-0.5));shardGeoms[c]=w}else w=shardGeoms[c];l=new Mesh(w,q);l.rt.set(rnd(),rnd(),rnd()).ms(Math.PI);l.sC.ms((40+30*
(rnd()-0.5))*Ws);l.V=rndV().aSc(-0.5).ms(5*speed).aS(g);l.ppos.cy(k.ppos).aS(tempV.cy(l.V).divideScalar(10));l.rotAxis=rndV().aSc(-0.5).ms(2).normalize();l.rV=rnd()*Math.PI/4;l.rA=0;l.traveled=0;l.maxDistance=j+(rnd()-0.25)*j;prepoB(l);k.shards[c]=l}return k}var tredoes=[],trMts=[];trMts.sH=new mBm({color:16724787,shading:FlatShading});aq+="V";
trMts.U=new mBm({color:3355647,shading:FlatShading});var trGeom=new lO([new v3(0,0,0.07),new v3(0.05,0,-0.03),new v3(0,0,-0.03)],3);aq+="k";
function CrTr(a,b,c){if(a==undefined)a=true;if(c==undefined)c=100*Ws/speed;for(var d=null,f=0;f<tredoes.length;f++)if(!tredoes[f].vs&&tredoes[f].fromsH==a){d=tredoes[f];break}if(d==null){d=new Mesh(trGeom,a?trMts.sH:trMts.U);d.sC.ms(50*Math.sqrt(Ws));tredoes.push(d);prepoB(d);d.cT=_Tr;cMpCOM(d)}d.vs=true;d.fromsH=a;d.ppos.cy(b.ppos);if(a){b=sH.rtMatrix.mV3(tempV.set(0,
0,-1));b.normalize().ms(60);d.ppos.aS(b);d.V=b.ms(0.7*speed).aS(sH.V).clone()}else{tempV.set(sH.ppos.x,sH.ppos.y,sH.ppos.z);a=rndV().aSc(-0.5).ms(0.5);tempV.subSelf(b.ppos).normalize().aS(a);d.ppos.cy(b.ppos);d.V=tempV.ms(12/b.size*speed).clone()}d.traveled=0;d.maxDistance=c;d.um();return d}
function cMpCOM(a){for(var b=new v3,c=a.gG.vts,d=0,f=c.length;d<f;d++)b.aS(c[d].ppos);b.divideScalar(c.length);return a.com=b}aq+="L";
function objectClosestTo(a){var b=null,c=null,d=9999999,f=scene.objects,g=a.com.clone();g=a.matrix.mV3(g);for(var j=0;j<f.length;j++)if(f[j].cT!=undefined){var l=f[j];if(l.vs)if(l!=a)if(l.cT!=a.cT)if(!(a.cT==_Tr&&a.fromsH==true&&l.cT==_sH))if(!(l.cT==_Tr&&l.fromsH==true&&a.cT==_sH))if(!(a.cT==_Tr&&a.fromsH==false&&l.cT==_UFO))if(!(l.cT==_Tr&&l.fromsH==false&&a.cT==_UFO)){var k=
l.com.clone(l.com);k=l.matrix.mV3(k);var q=g.distanceToSquared(k);if(q<d){d=q;b=l;c=k}}}return{dist:d,obj:b,com:c}}aq+="g";
function objectHitBy(a){var b=objectClosestTo(a);if(b.obj==null)return null;if(b.obj.cT!=_E&&b.dist>1E5||b.obj.cT==_E&&b.dist>1E6)return null;var c=tempV.cy(a.com);a.matrix.mV3(c);var d=a.V;if(d.x==0&&d.y==0&&d.z==0)d=b.obj.V;var f=c.clone().subSelf(d);d=c.clone().aS(d);var g=f.distanceToSquared(d),j=b.com;g=((j.x-f.x)*(d.x-f.x)+(j.y-f.y)*(d.y-f.y)+(j.z-f.z)*(d.z-f.z))/g;c.set(f.x+g*(d.x-f.x),f.y+g*(d.y-f.y),f.z+g*(d.z-f.z));c=j.distanceToSquared(c);
f=(new v3(b.obj.gG.bS.radius,b.obj.gG.bS.radius,b.obj.gG.bS.radius)).mS(b.obj.sC);CCFollowssH&&b.obj.cT==_sH&&f.ms(10);f=f.x+f.y+f.z;f=f*f/9;if(c<f)return b.obj;d=(new v3(a.gG.bS.radius,a.gG.bS.radius,a.gG.bS.radius)).mS(a.sC);CCFollowssH&&a.cT==_sH&&d.ms(10);d=d.x+d.y+d.z;d=d*d/9;if(c<f+d)return b.obj;
return null}function is(a){var b=score;score+=a;document.getElementById("Score").innerHTML="Score: "+score;if(score%5E3<b%5E3&&score>maxScore){nsHs+=1;document.getElementById("Lives").innerHTML="Lives: "+nsHs}maxScore=score>maxScore?score:maxScore}aq+="=";
function updateAstCount(){document.getElementById("nAst").innerHTML='Asteroids: <font color="#aa44aa">'+ASCount[2]+'</font><font color="#44aaaa"> '+ASCount[1]+'</font><font color="#aaaa44"> '+ASCount[0]+"<font>"}var startTime=lastTime=time(),sHHitTime=lastTime,lastTorpTime=lastTime,CCZ=1E3;
function la(){if(!paused){var a=time();a-startTime>1E4&&!keysDown.h&&hide("info");E.rt.y+=0.0020*Math.cos(26*Math.PI/180);E.um();M.orbitAngle-=0.02*Math.PI/180;M.ppos.set(500*Ws*Math.cos(M.orbitAngle),0,500*Ws*Math.sin(M.orbitAngle));M.rt.y=-M.orbitAngle;M.um();wp=function(k){var q=1E3*Ws;if(k.x>q)k.x-=2*q;else if(k.x<-q)k.x+=2*q;if(k.y>q)k.y-=2*q;else if(k.y<-q)k.y+=2*q;if(k.z>q)k.z-=2*q;else if(k.z<
-q)k.z+=2*q;return k};var b=true;if(sH.vs){sH.ppos=wp(sH.ppos.aS(sH.V));var c=false;if(EE>a-lastTime&&keysDown.w){var d=sH.rtMatrix.mV3(tempV.set(0,0,-1));d.normalize().ms(0.2*speed);sH.V.aS(d);c=sH.Th.fwd.vs=true}else sH.Th.fwd.vs=false;if(EE>a-lastTime&&keysDown.a){d=sH.rtMatrix.mV3(tempV.set(-1,0,0));d.normalize().ms(0.2*speed);sH.V.aS(d);
c=sH.Th.rt.vs=true}else sH.Th.rt.vs=false;if(EE>a-lastTime&&keysDown.d){d=sH.rtMatrix.mV3(tempV.set(1,0,0));d.normalize().ms(0.2*speed);sH.V.aS(d);c=sH.Th.lt.vs=true}else sH.Th.lt.vs=false;if(EE>a-lastTime&&keysDown.z){sH.V.ms(0.9);if(sH.V.length()>0.0010)c=true}if(c){EE-=a-lastTime;b=false}if(EE>a-lastTime&&keysDown.s){sH.sH.vs=true;EE-=
a-lastTime;b=false}else sH.sH.vs=false;if(EE>1E3&&a-lastTorpTime>330&&keysDown[" "]){CrTr(true,sH,40*Ws/speed);EE-=500;lastTorpTime=a;b=false}if(b&&EE<1E4){EE+=Math.round((a-lastTime)/2);if(EE>1E4)EE=1E4}if(EE<0)EE=0;document.getElementById("Energy").innerHTML="Energy: "+Math.floor(EE/100)*100;b=Math.PI*2/720/16*speed;if(keysDown.dn)sH.rV.x+=b;if(keysDown.up)sH.rV.x-=b;else if(Math.abs(sH.rV.x)>1.0E-7&&
!keysDown.dn&&!keysDown.up)sH.rV.x*=0.8;if(keysDown.lt)sH.rV.y+=b;if(keysDown.rt)sH.rV.y-=b;else if(Math.abs(sH.rV.y)>1.0E-7&&!keysDown.lt&&!keysDown.rt)sH.rV.y*=0.8;sH.rt.aS(sH.rV);sH.rtMatrix.setRotY(sH.rt.y);sH.rtMatrix.mS(tempM.setRotX(sH.rt.x));sH.matrix.setTranslation(sH.ppos.x,sH.ppos.y,sH.ppos.z);sH.matrix.mS(sH.rtMatrix);sH.matrix.mS(tempM.setScale(sH.sC.x,
sH.sC.y,sH.sC.z));if(CCFollowssH){sH.sC.set(5,5,7.5).ms(1*Math.sqrt(Ws));CC.ppos.cy(sH.ppos);d=sH.rtMatrix.mV3(tempV.set(0,0.6,1.2));d.normalize().ms(15*Math.sqrt(Ws));CC.ppos.aS(d);d=sH.rtMatrix.mV3(tempV.set(0,1,0));CC.up.cy(d.normalize());d=sH.rtMatrix.mV3(tempV.set(0,0,-1));d.normalize().ms(99999999);CC.target.ppos.cy(d);
CC.um()}else{sH.sC.set(5,5,7.5).ms(10*Math.sqrt(Ws));if(mouseDown){if(shiftPressed){if(Math.abs(mouseX-oldMouseX)>1)CCZ+=mouseX-oldMouseX}else{if(Math.abs(mouseX-oldMouseX)>1)CC.rt.x+=(mouseX-oldMouseX)*5.0E-4;if(Math.abs(mouseY-oldMouseY)>1)CC.rt.y-=(mouseY-oldMouseY)*5.0E-4}CC.ppos.set(Math.sin(CC.rt.x),Math.sin(CC.rt.y),Math.cos(CC.rt.x)*Math.cos(CC.rt.y)).ms(CCZ*Ws);
CC.um()}}}for(b=0;b<Us.length;b++){c=Us[b];if(!(c==null||!c.vs)){c.rt.y+=2*Math.PI/72/c.size;c.ppos=wp(c.ppos.aS(c.V));c.um();if(a>c.lastShot+(c.size==2?2E3:800)){CrTr(false,c,100*Ws/speed);c.lastShot=a;changeUFODirection(c)}}}for(b=0;b<ASs.length;b++){var f=ASs[b];if(!(f==null||!f.vs)){f.rA+=f.rV;f.ppos=wp(f.ppos.aS(f.V));f.um();tempM.setRotAxis(f.rotAxis,
f.rA);f.matrix.mS(tempM)}}for(b=tredoes.length-1;b>=0;b--){var g=tredoes[b];if(g.vs){var j=objectHitBy(g);if(j!=null){j.cT!=_sH&&CrEx(g.ppos,{V:j.V,color:j.color});g.traveled=g.maxDistance-1;g.vs=false;if(j.cT==_sH){if(!j.sH.vs){CrEx(j.ppos,{V:j.V,color:j.color});j.vs=j.window.vs=j.sH.vs=false;j.Th.fwd.vs=j.Th.lt.vs=false;j.Th.rt.vs=
j.cH.vs=false;sHHitTime=a}}else if(j.cT==_AS){j.vs=false;ASCount[j.index]--;g.fromsH==true&&is(30/(j.index+1));if(j.index>0){var l=0;if(j.index==2)l=2;else if(j.index==1)l=3;for(c=0;c<l;c++){f=CrAS(j.index-1);f.V.aS(j.V);f.ppos.cy(j.ppos);f.ppos.aS(tempV.cy(f.V).ms(3))}}updateAstCount()}else if(j.cT==_UFO){j.vs=j.window.vs=false;if(j.size==2)is(100);
else j.size==1.3&&is(250);nUFOs--;document.getElementById("UFOs").innerHTML="UFOs: "+nUFOs}else if(j.cT==_E)is(-10);else if(j.cT==_M){for(c=0;c<3;c++){f=CrAS(0);f.ppos.cy(g.ppos);f.ppos.aS(d.cy(f.V).ms(5))}is(-5);updateAstCount()}}}if(g.vs){g.rt.set(rnd(),rnd(),rnd()).ms(2*Math.PI);g.traveled+=1;g.ppos=wp(g.ppos.aS(g.V));g.um();if(g.traveled>
g.maxDistance)g.vs=false}}if(sH.vs){j=objectHitBy(sH);if(j!=null&&(j.cT==_AS||j.cT==_UFO||j.cT==_E||j.cT==_M)){CrEx(j.ppos,{V:j.V,color:j.color});CrEx(sH.ppos,{V:sH.V,color:sH.color});if(!sH.sH.vs){sH.vs=sH.window.vs=sH.sH.vs=false;sH.Th.fwd.vs=sH.Th.lt.vs=false;sH.Th.rt.vs=sH.cH.vs=false;
sHHitTime=a}if(j.cT==_AS){j.vs=false;is(30/(j.index+1));if(j.index>0){l=0;if(j.index==2)l=2;else if(j.index==1)l=3;for(c=0;c<l;c++){f=CrAS(j.index-1);f.V.aS(j.V);f.ppos.cy(j.ppos)}}}else if(j.cT==_UFO){j.vs=j.window.vs=false;if(j.size==2)is(100);else j.size==1.3&&is(250);nUFOs--;document.getElementById("UFOs").innerHTML="UFOs: "+nUFOs}}}for(b=exs.length-1;b>=0;b--){d=exs[b];
if(d!=null&&d.vs){if(d.index>=d.maxIndex){d.vs=false;d.light!=null&&scene.removeLight(d.light);scene.removeoB(d)}d.index++;d.mTs[0]=getExMt(d.index,d.color,d.path);if(d.light!=null){if(d.index<=8&&d.light.intensity>=0.01)d.light.intensity+=0.07;if(d.index>8)d.light.intensity*=0.8;d.light!=null&&d.index>8&&d.light.intensity<0.1&&scene.removeLight(d.light)}c=CC.ppos.clone().subSelf(d.ppos).normalize();f=tempV.cross(CC.up,c).normalize();g=(new v3).cross(c,
f).normalize();tempM.set(f.x,g.x,c.x,0,f.y,g.y,c.y,0,f.z,g.z,c.z,0,0,0,0,1);d.um();d.matrix.mS(tempM);f=d.shards;for(c=f.length-1;c>=0;c--){g=f[c];if(g!=null){g.traveled+=1;if(g.vs){g.rA+=g.rV;g.ppos=g.ppos.aS(g.V);g.um();tempM.setRotAxis(g.rotAxis,g.rA);g.matrix.mS(tempM)}if(g.traveled>=g.maxDistance||!d.vs){g.vs=false;scene.removeoB(g);f[c]=null}}}}else if(d!=null){d.light!=null&&scene.removeLight(d.light);
scene.removeoB(d);exs[b]=null}}if(a>=UTime){CrUFO();UTime=a+(3E4*Math.random()+2E4)*(nUFOs+1)}if(!sH.vs&&a-sHHitTime>5E3)if(nsHs>0){sH=CrsH();sH.ppos.z=800*Ws;sH.um()}else show("gameOver");stats!=null&&stats.update();renderer.render(scene,CC);lastTime=a}}aq+="=";
if(ibc())ia();else{document.getElementById("info").style.display="none";document.getElementById("gameOver").style.display="none";document.getElementById("oldie").style.display="block"}var mouseDown=false,mouseX=window.innerWidth/2,mouseY=window.innerHeight/2,oldMouseX,oldMouseY,shiftPressed=false;function onDocumentMouseMove(a){if(mouseDown){oldMouseX=mouseX;mouseX=a.clientX;oldMouseY=mouseY;mouseY=a.clientY;shiftPressed=a.shiftKey}}aq+="=";
function onDocumentMouseDown(a){mouseDown=true;mouseX=oldMouseX=a.clientX;mouseY=oldMouseY=a.clientY}aq+="d";function onDocumentMouseUp(){mouseDown=false}aq+="Q";var paused=false,keysDown=[];
function onDocumentKeyDown(a){if(!a)a=window.event;var b=String.fromCharCode(a.keyCode).toLowerCase();if(a.keyCode==38){b="up";a.preventDefault();a.stopPropagation()}else if(a.keyCode==40){b="dn";a.preventDefault();a.stopPropagation()}else if(a.keyCode==37){b="lt";a.preventDefault();a.stopPropagation()}else if(a.keyCode==39){b="rt";a.preventDefault();a.stopPropagation()}keysDown[b]=true;switch(b){case "p":paused=!paused;break;case "s":sH.sH.vs=true;break;case " ":a.preventDefault();a.stopPropagation();
break;case "v":CCFollowssH=!CCFollowssH;if(!CCFollowssH){CC.target.ppos.set(0,0,0);CC.up.set(0,1,0);CC.ppos.set(Math.sin(CC.rt.x),Math.sin(CC.rt.y),Math.cos(CC.rt.x)*Math.cos(CC.rt.y)).ms(CCZ*Ws);CC.um()}break;case "x":sH.cH.vs=false;break;case "u":CrUFO();break;case "h":show("info")}}aq+="D";
function onDocumentKeyUp(a){if(!a)a=window.event;var b=String.fromCharCode(a.keyCode).toLowerCase();if(a.keyCode==38)b="up";else if(a.keyCode==40)b="dn";else if(a.keyCode==37)b="lt";else if(a.keyCode==39)b="rt";keysDown[b]=false;switch(b){case "w":sH.Th.fwd.vs=false;break;case "a":sH.Th.rt.vs=false;break;case "d":sH.Th.lt.vs=false;break;case "s":sH.sH.vs=false;case "x":sH.cH.vs=true;break;case "h":hide("info")}};
